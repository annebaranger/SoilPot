---
title: "Report Jan"
author: "Anne Baranger"
date: "01/02/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(targets)
Sys.setenv(TAR_PROJECT="analysis2")
lapply(c("ggplot2","stringr","data.table","tidyr","viridis","rgdal","raster","rosm","terra","dplyr","forcats","ggpubr","gdalUtils","sf","lubridate","lme4","xtable","plotly","factoextra","latex2exp"),require,character.only=TRUE)
```

# Load necessary files

* df.species : all tree species for which there LT50 and P50 measures available, including non-european-native species
* mod.select.safmarg : results of the model for species of the previous selection. It was done using df.traits gathering all species with LT50/P50, present in Mauri dataset (ie present in europe) and not filtered out because of expertise
* df.traits 'new' : species of europe with LT50/P50
* db.clim : mauri dataset with all species over 400 presence
* species.europe : list of european species according to euforgen (enough occurrences to draw a distribution)
```{r files.occ}
tar_load(df.species) 
db.clim<-tar_read(occurence,store="target_occ") |> 
  left_join(df.species) |> 
  mutate(hsm=(psi_eraday_real/1000)-px,
         fsm=tmin_era-lt50) 

tar_load(europe,store="target_data")
europe=st_as_sf(europe)
```


```{r files.traits}
head(df.species)
df.species <- df.species |>
  left_join(
    db.clim |> filter(presence==1) |> 
      group_by(species) |> 
      summarise(n=n()))

tar_load(traits,store="target_occ") #only species with both traits

species.europe=list.files("data/chorological_maps_dataset/")

# tar_load(df.P50,store="target_safetymargin")
# tar_load(df.LT50,store="target_safetymargin")
# df.LT50=df.LT50$df.LT50sp.cor
# 
# df.traits.all=df.P50%>% #all species for which there is at least one of the two traits
#   left_join(df.LT50,by=c("species"="Species")) |> 
#   rename_with(.cols=everything(),
#                 tolower) |> 
#   dplyr::select(species,taxa,p50.mu,p50.sd,p88.mu,p88.sd,lt50,lt50.sd,bdd) |> 
#   filter(species %in% species.europe) |> 
#   mutate(p.trait=case_when(taxa=="gymnosperm"~"p50",
#                              taxa=="angiosperm"&!is.na(p88.mu)~"p88",
#                              taxa=="angiosperm"&is.na(p88.mu)~"p50"),
#            px=case_when(p.trait=="p88"~p88.mu,
#                            p.trait=="p50"~p50.mu),
#            px.sd=case_when(p.trait=="p88"~p88.sd,
#                            p.trait=="p50"~p50.sd))
# rm(df.P50,df.LT50)
# 
# df.species <- df.species |> 
#   left_join(df.traits.all)

df.species.rest <- df.species |> 
  filter(!is.na(p50)&!is.na(lt50)) |> 
  filter(species %in% unique(db.clim$species))

# rm(df.traits,df.traits.all)
```

```{r files.mod}
tar_load(mod.select.safmarg)
tar_load(mod.select.safmarg_beta)
tar_load(margin.limit,store="target_occ")
# load("output/df.quant.final.RData")
```

# Maps of incicators


```{r indicator.safetymargins}
psi=aggregate(c(rast(tar_read(psi_eraday_100,store="target_psi2")[,c("x","y","psi")]),
                rast(tar_read(psi_eraday_real,store="target_psi2")[,c("x","y","psi")])),
              10,
              method="near")
names(psi)=c("psi_100","psi_real")

tmin=rast(tar_read(tmin2m_era,store="target_data"))
names(tmin)="tmin"
# compute safety margins for Fagus sylvatica
safety.margins=as.data.frame(aggregate(c(psimin,tmin),
                                       fact=4),
                             xy=TRUE) |> 
  mutate(hsm=psi-df.species[df.species$species=="Fagus sylvatica",
                            "px"]*1000,
         fsm=tmin-df.species[df.species$species=="Fagus sylvatica",
                            "lt50"])

# plot difference between psi at real depth and at 100cm
as.data.frame(psi,xy=TRUE)|>
  mutate(dif=cut(psi_real-psi_100,
                 breaks=c(-Inf, -10000, -5000,-3000,0,500,1000,5000,Inf),
                         labels=c("<-10MPa","-10<HSM<-5MPa","-5<HSM<-3MPa",
                                  "-3<HSM<0MPa","0/0.5","0.5/1","1/5",">5MPa"))) |> 
  ggplot()+
  geom_tile(aes(x=x,y=y,fill=dif))+
  geom_sf(data=europe,
                  fill=NA)+
  coord_sf()+
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text = element_blank(),
        legend.key.size = unit(0.5,"cm"),
        legend.text = element_text(size=8),
        legend.title = element_text(size=9))+
          scale_fill_brewer(palette="RdYlBu")

# maps of psi at real depth and 100cm
as.data.frame(psi,xy=TRUE)|>
    mutate(psi_real=cut(psi_real,
                 breaks=c(-Inf, -15000, -10000, -5000,-3000, -2000, -1000, -500, 0,Inf),
                         labels=c("<-15MPa","-15<HSM<-10MPa","-10<HSM<-5MPa",
                                  "-5<psi<-3MPa","-3/-2","-2/-1","-1/-0.5","-0.5/0",">0MPa")),
           psi_100=cut(psi_100,
                 breaks=c(-Inf, -15000, -10000, -5000,-3000, -2000, -1000, -500, 0,Inf),
                         labels=c("<-15MPa","-15<HSM<-10MPa","-10<HSM<-5MPa",
                                  "-5<psi<-3MPa","-3/-2","-2/-1","-1/-0.5","-0.5/0", ">0MPa"))) |> 
  pivot_longer(cols=c("psi_real","psi_100")) |> 
  ggplot()+
  geom_tile(aes(x=x,y=y,fill=value))+
  geom_sf(data=europe,
                  fill=NA)+
  coord_sf()+
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text = element_blank(),
        legend.key.size = unit(0.5,"cm"),
        legend.text = element_text(size=8),
        legend.title = element_text(size=9))+
          scale_fill_brewer(palette="RdYlBu")+
  facet_wrap(~name)

# plot tmin
as.data.frame(tmin,
              xy=TRUE) |> 
  mutate(tmin=cut(tmin,
                 breaks=c(-Inf, -50,-40, -30,-20,-15,-10,-5,0,Inf),
                 labels=c("<-50", "-50<tmin<-40","-40/-30","-30/-20","-20/-15","-15/-10","-10/-5",
                          "-5/0",">0"))) %>%
  ggplot() +
  geom_tile(aes(x=x,y=y,fill=tmin))+
  geom_sf(data=europe,
                  fill=NA)+
  coord_sf()+
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text = element_blank(),
        legend.key.size = unit(0.5,"cm"),
        legend.text = element_text(size=8),
        legend.title = element_text(size=9))+
          scale_fill_brewer(palette="RdYlBu")

# plot psimin
as.data.frame(rast(tar_read(psi_eraday_real,store="target_psi2")[,c("x","y","psi")]),
              xy=TRUE) |> 
    mutate(psi_real=cut(psi,
                 breaks=c(-Inf, -15000, -10000, -5000,-3000, -2000, -1000, -500, 0,Inf),
                         labels=c("<-15MPa","-15<HSM<-10MPa","-10<HSM<-5MPa",
                                  "-5<psi<-3MPa","-3/-2","-2/-1","-1/-0.5","-0.5/0",">0MPa"))) |> 
  ggplot()+
  geom_tile(aes(x=x,y=y,fill=psi_real))+
  geom_sf(data=europe,
                  fill=NA)+
  coord_sf()+
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text = element_blank(),
        legend.key.size = unit(0.5,"cm"),
        legend.text = element_text(size=8),
        legend.title = element_text(size=9))+
          scale_fill_brewer(palette="RdYlBu")

# rm(psimin,psimin100,safety.margins,tmin)
```

# Plot of physiological traits

```{r p50.distribution}
#Plot of P50 and P88
# df.species |>
#   filter(!is.na(p50.mu)) |> 
#   filter(species %in% mod.select.safmarg$species) |> 
#   select(species,px,px.sd,p.trait) |> 
#   mutate(species=fct_reorder(species,px),
#          na.sd=case_when(is.na(px.sd)~"mean",
#                          TRUE~"true"),
#          px.sd=case_when(is.na(px.sd)~mean(df.species$px.sd,na.rm=TRUE),
#                          TRUE~px.sd)) |> 
#   ggplot(aes(px,species,color=p.trait)) +
#   geom_point()+
#   geom_pointrange(aes(xmin=px-px.sd,xmax=px+px.sd))+
#   theme_minimal()+
#   labs(color="",
#        y="",
#        x="Pcrit")

cowplot::plot_grid(
  #only p50
  df.species |>
    filter(!is.na(p50)) |> 
    filter(species %in% mod.select.safmarg$species) |> 
    select(species,p50,p50sd,taxa) |> 
    mutate(species=fct_reorder(species,p50),
           na.sd=case_when(is.na(p50sd)~"mean",
                           TRUE~"true"),
           p50sd=case_when(is.na(p50sd)~mean(df.species$p50sd,na.rm=TRUE),
                           TRUE~p50sd)) |> 
    ggplot(aes(p50,species,color=taxa)) +
    geom_point()+
    geom_pointrange(aes(xmin=p50-p50sd,xmax=p50+p50sd))+
    theme_minimal()+
    scale_color_manual(values=c("chocolate2","forestgreen"))+
    labs(color="",
         y="",
         x="P50"),
  #only LT50
  df.species |>
    filter(!is.na(lt50)) |> 
    filter(species!="Juniperus communis") |> 
    filter(species %in% mod.select.safmarg$species) |> 
    select(species,lt50,lt50_sd,taxa) |> 
    mutate(species=fct_reorder(species,lt50),
           na.sd=case_when(is.na(lt50_sd)~"mean",
                           TRUE~"true"),
           lt50_sd=case_when(is.na(lt50_sd)~mean(df.species$lt50_sd,na.rm=TRUE),
                           TRUE~lt50_sd)) |> 
    ggplot(aes(lt50,species,color=taxa)) +
    geom_point()+
    geom_pointrange(aes(xmin=lt50-lt50_sd,xmax=lt50+lt50_sd))+
    theme_minimal()+
    scale_color_manual(values=c("chocolate2","forestgreen"))+
    labs(color="",
         y="",
         x="LT50")
)


# Common plot for standardized traits
df.species |>
  filter(!is.na(lt50)) |> 
  filter(species!="Juniperus communis") |> 
  filter(species %in% mod.select.safmarg$species) |> 
  select(species,p50,p50sd,lt50,lt50_sd,taxa) |> 
  mutate(species=fct_reorder(species,p50),
         na.sd=case_when(is.na(lt50_sd)~"mean",
                         TRUE~"true"),
         lt50_sd=case_when(is.na(lt50_sd)~mean(df.species$lt50_sd,na.rm=TRUE),
                         TRUE~lt50_sd),
         p50sd=case_when(is.na(p50sd)~mean(df.species$p50sd,na.rm=TRUE),
                         TRUE~p50sd),
         across(.cols=c("p50","lt50"),
                scale),
         p50sd=p50sd/abs(mean(df.species$p50,na.rm=TRUE)),
         lt50_sd=lt50_sd/abs(mean(df.species$lt50,na.rm=TRUE))) |>
  pivot_longer(cols=c("p50","lt50"),names_to = "mean",values_to = "mean_val") |> 
  pivot_longer(cols=c("lt50_sd","p50sd"),names_to = "sd",values_to = "sd_val") |> 
  filter((mean=="p50"&sd=="p50sd")|
           (mean=="lt50"&sd=="lt50_sd")) |> 
  mutate(mean=case_when(mean=="p50"~"P50",
                         mean=="lt50"~"LT50")) |> 
  ggplot(aes(mean_val,species,color=mean)) +
  geom_point()+
  geom_pointrange(aes(xmin=mean_val-sd_val,xmax=mean_val+sd_val))+
  theme_minimal()+
  scale_color_manual(values=c("steelblue","darkred"))+
  labs(color="",
       y="",
       x="Standardized values")
scale_factor <- max(df.species$lt50,na.rm = TRUE) / max(df.species$p50,na.rm=TRUE)
df.species |>
  filter(!is.na(lt50)) |> 
  filter(species!="Juniperus communis") |> 
  filter(species %in% mod.select.safmarg$species) |> 
  select(species,p50,p50sd,lt50,lt50_sd,taxa) |> 
  mutate(species=fct_reorder(species,p50),
         na.sd=case_when(is.na(lt50_sd)~"mean",
                         TRUE~"true"),
         lt50_sd=case_when(is.na(lt50_sd)~mean(df.species$lt50_sd,na.rm=TRUE),
                         TRUE~lt50_sd),
         p50sd=case_when(is.na(p50sd)~mean(df.species$p50sd,na.rm=TRUE),
                         TRUE~p50sd))  |> 
  ggplot(aes(y = species)) +
  geom_point(aes(x = lt50), color = "steelblue") +
  geom_pointrange(aes(x = lt50, 
                      xmin = lt50 - lt50_sd, 
                      xmax = lt50 + lt50_sd), color = "steelblue") +
  geom_point(aes(x = p50 * scale_factor), color = "darkred") +
  geom_pointrange(aes(x = p50 * scale_factor, 
                      xmin = (p50 - p50sd) * scale_factor, 
                      xmax = (p50 + p50sd) * scale_factor), color = "darkred") +
  scale_x_continuous(name = "LT50 scale",
                     sec.axis = sec_axis(~ . / scale_factor, name = "P50 scale"))+
  theme_minimal()
```

# Species selection and traits using euforgen

```{r quantEuforgen, eval=FALSE, include=FALSE}
plot.distrib<-function(sp){
   db.pres <- db.clim %>% 
        filter(species==sp) 
      #load euforgen distrib
   file.sp=df.quant[df.quant$species==sp,"file"][[1]]
   path=file.path("data",
                   "chorological_maps_dataset",
                   sp,
                   "shapefiles")
  file.list=grep("plg_clip\\.",
                           list.files(path),
                           value = TRUE)
  file.sp=unique(vapply(strsplit(file.list,"\\."), `[`, 1, FUN.VALUE=character(1)))
  spdistrib=do.call(rbind,lapply(file.sp,function(x)read_sf(dsn=path,x))) |> 
    summarise(geometry = sf::st_union(geometry)) 
  spdistrib=st_crop(spdistrib,
                    xmin=-10,
                    xmax=28.231836,
                    ymin=st_bbox(spdistrib)$ymin[[1]],
                    ymax=st_bbox(spdistrib)$ymax[[1]])
  print(
    db.pres |>
        filter(presence!=0) |>
        ggplot()+
        geom_point(aes(x,y),size=0.1)+
        geom_sf(data=spdistrib,alpha=0.5)+
        geom_sf(data=europe,alpha=0.1)
  )
}
plot.distrib("Juniperus thurifera")


# plot lat.mean per model for species with data enabling natural selection of data
mod.select.safmarg |> 
  filter(mod!="none") |> 
  left_join(df.quant.final) |>
  select(species,mod,lat.mean,hsm.valid.3,fsm.valid.2) |> 
  filter(hsm.valid.3==TRUE&fsm.valid.2==TRUE) |> 
  ggplot(aes(mod,lat.mean))+
  geom_boxplot()
mod.select.safmarg |> 
  filter(mod!="none") |> 
  left_join(df.quant.final) |>
  select(species,mod,lat.mean,hsm.valid.2,fsm.valid.2) |> 
  filter(hsm.valid.2==TRUE&fsm.valid.2==TRUE) |> 
  ggplot(aes(mod,lat.mean))+
  geom_boxplot()

# load("output/df.quant.final.RData")
```

# Plot model output

## Parameters of the model

### slope/slope
  
```{r par_r}
mod.select.safmarg %>% 
  ggplot(aes(r_hsm,r_fsm,color=species,shape=mod,label=species))+ #size=-log(Rhat),
  geom_point()+
  geom_text(hjust=0,vjust=0)+
  theme_minimal()
```

### Threshold/threshold
```{r par_t}
mod.select.safmarg %>% 
  ggplot(aes(t_fsm,t_hsm,color=species,shape=mod,label=species))+
  geom_text(hjust=0,vjust=0)+
  geom_point(size=5)+
  theme_minimal()

```

### Threshold/slope
```{r par_t_preval}
mod.select.safmarg %>% 
  filter(mod %in% c("2sm","hsm")) |> 
  ggplot(aes(r_hsm,t_hsm,color=species,shape=mod,label=species))+
  geom_text(hjust=0,vjust=0)+
  geom_point(size=5)+
  theme_minimal()
cowplot::plot_grid(
  mod.select.safmarg %>%
    left_join(df.species) |> 
    filter(mod %in% c("2sm","hsm")) |> 
    ggplot(aes(r_hsm,t_hsm,color=prevalence,shape=mod,label=species))+
    geom_text(hjust=0,vjust=0)+
    geom_point(aes(size=prevalence,color=inflex_hsm))+
    theme_minimal(),
  mod.select.safmarg %>%
    left_join(df.species) |> 
    filter(mod %in% c("2sm","fsm")) |> 
    ggplot(aes(r_fsm,t_fsm,color=prevalence,shape=mod,label=species))+
    geom_text(hjust=0,vjust=0)+
    geom_point(size=5)+
    theme_minimal()
  )



```


## Parameters / traits

### t / traits

t_fsm centered in zero : it confirms the assumption of a non-linear relation with a threshold corresponding to a physiological threshold.
t_hsm with an increaing relation with P50 : the P50 threshold is not relevant to determining the non-linearity threshold.

```{r par_t_traits}
mod.select.safmarg %>%
  left_join(df.species) |> 
  select(species,px,lt50,t_hsm,t_fsm,mod,prevalence,inflex_hsm) %>% 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("t_fsm","t_hsm"),names_to="threshold",values_to="threshold_val") %>% 
  filter((mod%in%c("hsm","2sm")&traits=="px"&threshold=="t_hsm")|
           (mod%in%c("fsm","2sm")&traits=="lt50"&threshold=="t_fsm")) %>% 
  # mutate(app_thresh=-traits_val-threshold_val) %>% 
  ggplot(aes(traits_val,threshold_val,label=species,shape=mod))+
  geom_point(aes(size=prevalence,color=inflex_hsm))+
  geom_text(hjust=0,vjust=0)+
  # geom_abline(slope=-1)+
  geom_smooth(method="gam",aes(color=NULL,label=NULL,shape=NULL))+
  facet_wrap(traits~threshold,scales="free")+
  theme(legend.position = "none")+
  theme_minimal()+
  NULL


mod.select.safmarg %>% 
  left_join(df.species) |> 
  select(species,px,p50sd,lt50,lt50_sd,t_hsm,t_fsm,mod,prevalence) %>% 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("p50sd","lt50_sd"),names_to = "traits.sd",values_to = "traits_sd") %>% 
  pivot_longer(cols=c("t_fsm","t_hsm"),names_to="threshold",values_to="threshold_val") %>% 
  filter((mod%in%c("hsm","2var")&traits=="px"&traits.sd=="p50sd"&threshold=="t_hsm")|
           (mod%in%c("fsm","2var")&traits=="lt50"&traits.sd=="lt50_sd"&threshold=="t_fsm")) %>% 
  filter(traits=="px") |> 
  # mutate(app_thresh=-traits_val-threshold_val) %>% 
  ggplot(aes(traits_val,threshold_val,label=species,shape=mod))+
  geom_point(aes(size=2,color=traits_sd))+
  geom_text(hjust=0,vjust=0)+
  # geom_abline(slope=-1)+
  facet_wrap(traits~threshold,scales="free")+
  theme(legend.position = "none")+
  theme_minimal()+
  NULL
```
Parameters are just higher for species more abundant, in order to reach higher values. No clear link with inflexion. 
Not observed for fsm. 
It confirms that HSM might not be a great indicator to catch presence absence of species.


Same conclusion. Link with abundance for HSM.

```{r par_t_n}
cowplot::plot_grid(
  mod.select.safmarg |> 
    left_join(df.species) |> 
    filter(!mod%in%c("hsm","none")) |> 
    ggplot(aes(n,t_fsm))+
    geom_point()+
    theme_minimal()+
    geom_smooth(method="gam"),
  mod.select.safmarg |> 
    left_join(df.species) |> 
    filter(!mod%in%c("fsm","none")) |> 
    ggplot(aes(n,t_hsm))+
    geom_point()+
    theme_minimal()+
    geom_smooth(method="gam")
)
# test significance
# df.lm=mod.select.safmarg |> 
#   left_join(df.species) |> 
#   filter(!mod%in%c("fsm","none"))
# summary(lm(t_hsm~px+prevalence,df.lm))
# rm(df.lm)
```

## Traits / niche

```{r trait_quantile}
db.clim |> 
  filter(!is.na(px)) |> 
  mutate(species=fct_reorder(species,px)) |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-15000)) |>
  pivot_longer(cols=c("psi_eraday_real","wai","pet","sgdd")) |> 
  # mutate(hsm_sc=hsm/px) |> 
  ggplot(aes(value,species))+
  geom_boxplot(outlier.shape = NA)+
  facet_wrap(~name,scales="free")


db.clim |> 
  # mutate(px=-px,
  #    lt50=-lt50,
  #    psi_eraday_real=-psi_eraday_real,
  #    wai=-wai) |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |>
  pivot_longer(cols=c("tmin_era","psi_eraday_real","wai","pet","sgdd","map")) |> 
  group_by(name) |> 
  # mutate(value=scale(value)) |> 
  ungroup() |> 
  group_by(species,name,lt50) |> 
  summarise(quant05=quantile(value,probs=0.05,na.rm=TRUE),
            quant95=quantile(value,probs=0.95,na.rm=TRUE)) |> 
  ggplot(aes(color=species))+
  geom_point(aes(lt50,quant05),color="darkred")+
  geom_point(aes(lt50,quant95),color="lightblue")+
  geom_smooth(aes(lt50,quant05),color="darkred",method="gam")+
  geom_smooth(aes(lt50,quant95),color="lightblue",method="gam")+  # geom_segment(aes(x=trait_val,xend=trait_val,y=start_val,yend=end_val),alpha=0.3)+
  facet_wrap(~name,scales="free")

db.clim |> 
  # mutate(px=-px,
  #    lt50=-lt50,
  #    psi_eraday_real=-psi_eraday_real,
  #    wai=-wai) |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-15000)) |>
  pivot_longer(cols=c("tmin_era","psi_eraday_real","wai","pet","sgdd","map")) |> 
  group_by(name) |> 
  # mutate(value=scale(value)) |> 
  ungroup() |> 
  group_by(species,name,p50) |> 
  summarise(quant05=quantile(value,probs=0.05,na.rm=TRUE),
            quant95=quantile(value,probs=0.95,na.rm=TRUE)) |> 
  ggplot(aes(color=species))+
  geom_point(aes(p50,quant05),color="darkred")+
  geom_point(aes(p50,quant95),color="lightblue")+
  geom_smooth(aes(p50,quant05),color="darkred",method="gam")+
  geom_smooth(aes(p50,quant95),color="lightblue",method="gam")+  # geom_segment(aes(x=trait_val,xend=trait_val,y=start_val,yend=end_val),alpha=0.3)+
  facet_wrap(~name,scales="free")

```


```{r traits.lm}
predictor=c("tmin_era","psi_eraday_real","sgdd","wai","pet","map")
db.clim.lm<- 
  db.clim |>  
  filter(presence==1) |> 
  filter(psi_eraday_real>(-15000)) |>
  pivot_longer(cols=predictor) |> 
  group_by(name) |> 
  mutate(value=scale(value)) |> 
  ungroup() |> 
  group_by(species,name,lt50,px) |> 
  summarise(quant05=quantile(value,probs=0.05,na.rm=TRUE)[[1]],
            quant95=quantile(value,probs=0.95,na.rm=TRUE)[[1]]) |> 
  ungroup() |> 
  pivot_longer(cols=c("quant05","quant95"),
               names_to="quant_name",
               values_to = "quant_val")
df.lm.traits<-data.frame(pred=rep(predictor,2)) |> 
  crossing(trait=c("lt50","px"),
           quant=c("quant05","quant95"),
           mean=NA,
           sd=NA,
           pval=NA,
           conf.up=NA,
           conf.low=NA)


for(pred in predictor){
  print(pred)
  for(quant in c("quant05","quant95")){
    print(quant)
    db.clim.pred<-db.clim.lm |> 
      filter(name==pred) |> 
      filter(quant_name==quant)
    summary=as.data.frame(summary(lm(quant_val~px,db.clim.pred))$coefficients)
    conf=confint(lm(formula = quant_val ~ px, data = db.clim.pred))
    print(summary(lm(quant_val~px,db.clim.pred)))
    df.lm.traits[df.lm.traits$pred==pred&
                   df.lm.traits$quant==quant&
                   df.lm.traits$trait=="px",
                 c("mean","sd","pval","conf.up","conf.low")]=
      c(summary["px",c("Estimate","Std. Error","Pr(>|t|)")],
        conf["px",1],
        conf["px",2])
    summary=as.data.frame(summary(lm(quant_val~lt50,db.clim.pred))$coefficients)
    conf=confint(lm(formula = quant_val ~ lt50, data = db.clim.pred))
    print(summary(lm(quant_val~lt50,db.clim.pred)))
    df.lm.traits[df.lm.traits$pred==pred&
                   df.lm.traits$quant==quant&
                   df.lm.traits$trait=="lt50",
                 c("mean","sd","pval","conf.up","conf.low")]=
      c(summary["lt50",c("Estimate","Std. Error","Pr(>|t|)")],
        conf["lt50",1],
        conf["lt50",2])
  }

}   

df.lm.traits<-df.lm.traits |> 
  mutate(signif=pval<0.05)

df.lm.traits |> 
  ggplot(aes(x=mean,y=pred,color=quant))+
  scale_color_manual(values=c("darkred","lightblue"))+
  geom_point(size=2.5,alpha=0.6,position=position_dodge(width=0.5))+
  geom_pointrange(aes(xmin=conf.low,xmax=conf.up),position=position_dodge(width=0.5))+
  geom_text(aes(label = ifelse(signif, "*", "")), 
            position = position_dodge(width = 0.8),hjust=5)+
  geom_vline(xintercept = 0,linetype="dotted")+
  theme_minimal()+
  facet_wrap(~trait,scales="free_x")+
  theme(axis.title= element_blank(),
        axis.ticks.x = element_line(linewidth = 0.6),
        axis.line.x = element_line(linewidth = 0.6),
        panel.grid = element_blank(),
        legend.position = "none",
        axis.text.y = element_text(hjust=0.5))
# rm(df.lm.traits,db.clim.lm,db.clim.pred,conf,pred,quant,predictor)

```



### drafts


```{r par_t_n2, eval=FALSE, include=FALSE}

# distribution des marges de sécurité en fonction du P50
db.clim |> 
  left_join(df.species) |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |> 
  group_by(species,px,prevalence) |> 
  summarise(min.hsm=quantile(hsm,probs=0.01,na.rm=TRUE),
           max.hsm=quantile(hsm,probs=0.99,na.rm=TRUE),
           med.hsm=median(hsm,na.rm=TRUE)) |> 
  pivot_longer(cols=c("min.hsm","max.hsm")) |> 
  ggplot(aes(px,value,color=name))+
  geom_point()+
  geom_smooth(method='lm')+
  labs(title = "quantiles of HSM relative to P50")

db.clim |> 
  left_join(df.species) |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |> 
  group_by(species,px,prevalence) |> 
  summarise(q05.psi=quantile(hsm,probs=0.05,na.rm=TRUE)) |> 
  ggplot(aes(px,q05.psi))+
  geom_point()+
  geom_smooth(method='lm')

db.clim |> 
  mutate(species=fct_reorder(species,px)) |> 
  filter(presence==1) |> 
  filter(psi>(-15000)) |>
  mutate(hsm_sc=hsm/px) |> 
  ggplot(aes(hsm_sc,species))+
  geom_boxplot(outlier.shape = NA)




db.clim |> 
  left_join(df.species) |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |> 
  filter(!is.na(px)) |> 
  group_by(species,px,prevalence) |> 
  summarise(min.hsm=quantile(psi,probs=0.01),
            max.hsm=quantile(psi,probs=0.99)) |> 
  mutate(hsm.width=max.hsm-min.hsm) |> 
  ggplot(aes(px,hsm.width/1000,color=species))+
  geom_point(aes(size=prevalence))+
  geom_smooth(method='gam')+
  theme(legend.position = "none")+
  # geom_abline(slope = -1)+
  NULL

db.clim |> 
  left_join(df.species) |> 
  left_join(mod.select.safmarg) |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-15000)) |> 
  filter(!is.na(t_hsm)) |> 
  group_by(species,t_hsm,prevalence) |> 
  summarise(min.hsm=quantile(psi,probs=0.01),
           max.hsm=quantile(psi,probs=0.99)) |> 
  mutate(hsm.width=max.hsm-min.hsm) |> 
  ggplot(aes(t_hsm,hsm.width/1000))+
  geom_point(aes(size=prevalence))+
  geom_smooth(method='gam')+
  theme(legend.position = "none")+
  # geom_abline(slope = -1)+
  NULL

```

### t / traits contribution

```{r par_t_contrib, echo=FALSE}
mod.select.safmarg %>% 
  left_join(df.species) |> 
  select(species,px,lt50,t_hsm,t_fsm,mod,inflex_fsm,inflex_hsm) %>% 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("t_fsm","t_hsm"),names_to="threshold",values_to="threshold_val") %>% 
  pivot_longer(cols=c("inflex_fsm","inflex_hsm"),names_to="inflex",values_to="inflex_val") %>% 
  filter((traits=="px"&threshold=="t_hsm"&inflex=="inflex_hsm")|
           (traits=="lt50"&threshold=="t_fsm"&inflex=="inflex_fsm")) %>% 
  filter((mod=="hsm"&threshold=="t_hsm")|
           (mod=="fsm"&threshold=="t_fsm")|
           (mod=="2sm"&threshold%in%c("t_hsm","t_fsm"))) %>% 
  mutate(contribution=100*(-traits_val-threshold_val)/(-traits_val)) %>% 
  ggplot(aes(contribution,species,color=inflex_val,shape=mod))+
  geom_point(size=3)+
  geom_vline(xintercept = 100)+
  scale_color_gradientn(colours = viridis(15))+
  facet_wrap(~traits)

mod.select.safmarg %>% 
  left_join(df.species) |>
  select(species,px,lt50,t_hsm,t_fsm,mod,inflex_fsm,inflex_hsm) %>% 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("t_fsm","t_hsm"),names_to="threshold",values_to="threshold_val") %>% 
  pivot_longer(cols=c("inflex_fsm","inflex_hsm"),names_to="inflex",values_to="inflex_val") %>% 
  filter((traits=="px"&threshold=="t_hsm"&inflex=="inflex_hsm")|
           (traits=="lt50"&threshold=="t_fsm"&inflex=="inflex_fsm")) %>% 
  filter((mod=="hsm"&threshold=="t_hsm")|
           (mod=="fsm"&threshold=="t_fsm")|
           (mod=="2sm"&threshold%in%c("t_hsm","t_fsm"))) %>% 
  mutate(contribution=100*(threshold_val)/(-traits_val)) %>% 
  ggplot(aes(traits_val,contribution,color=inflex_val,shape=mod))+
  geom_point(size=3)+
  scale_color_gradientn(colours = viridis(5))+
  geom_smooth(method="gam",aes(color=NULL,shape=NULL))+
  facet_wrap(~traits,scales="free")+
  theme_minimal()
```

### t rescaled / traits

```{r t_scaled}
df.range<-db.clim |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |> 
  group_by(species) |> 
  summarise(psi_range=max(psi_eraday_real)/1000-min(psi_eraday_real)/1000,
            t_range=max(tmin_era)-min(tmin_era))


mod.select.safmarg %>%
  left_join(df.species) |>
  left_join(df.range) |> 
  select(species,px,lt50,t_hsm,t_fsm,mod,psi_range,t_range) %>% 
  mutate(t_hsm_scaled=t_hsm/psi_range,
         t_fsm_scaled=t_fsm/t_range) |> 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("t_hsm_scaled","t_fsm_scaled"),names_to="threshold",values_to="threshold_val") %>% 
  filter((mod%in%c("hsm","2sm")&traits=="px"&threshold=="t_hsm_scaled")|
           (mod%in%c("fsm","2sm")&traits=="lt50"&threshold=="t_fsm_scaled")) %>% 
  mutate(app_thresh=-traits_val-threshold_val) %>% 
  ggplot(aes(traits_val,threshold_val,color=species,label=species,shape=mod))+
  geom_point(size=3)+
  geom_text(hjust=0,vjust=0)+
  geom_abline(slope=-1)+
  geom_smooth(method="gam",aes(color=NULL,label=NULL,shape=NULL))+
  facet_wrap(traits~threshold,scales="free_x")+
  theme(legend.position = "none")+
  theme_minimal()+
  NULL



mod.select.safmarg %>%
  left_join(df.species) |>
  left_join(df.range) |> 
  select(species,px,lt50,t_hsm,t_fsm,mod,psi_range,t_range) %>% 
  mutate(t_hsm_scaled=t_hsm/psi_range,
         t_fsm_scaled=t_fsm/t_range) |> 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("t_hsm_scaled","t_fsm_scaled"),names_to="threshold",values_to="threshold_val") %>% 
  filter((mod%in%c("hsm","2sm")&traits=="px"&threshold=="t_hsm_scaled")|
           (mod%in%c("fsm","2sm")&traits=="lt50"&threshold=="t_fsm_scaled")) %>% 
  ggplot(aes(threshold,threshold_val))+
  geom_boxplot()+
  theme_minimal()
```



### r / traits
```{r par_r_trait}
mod.select.safmarg %>%
  left_join(df.species) |>
  select(species,px,lt50,r_hsm,r_fsm,mod) %>% 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("r_fsm","r_hsm"),names_to="slope",values_to="slope_val") %>% 
  filter((traits=="px"&slope=="r_hsm")|
           (traits=="lt50"&slope=="r_fsm")) %>% 
  filter(slope_val<20) %>% 
  ggplot(aes(traits_val,slope_val,color=species,label=species,shape=mod))+
  geom_point(size=3)+
  geom_text(hjust=0,vjust=0)+
  theme(legend.position = "none")+
  facet_wrap(traits~slope,scales="free")
```

# Curves fit

## All species 

### HSM
```{r curves_sp_hsm}
hsm.95=quantile(db.clim$hsm,prob=0.95,na.rm=TRUE)[[1]]
hsm.05=quantile(db.clim$hsm,prob=0.05,na.rm=TRUE)[[1]]
fsm.95=quantile(db.clim$fsm,prob=0.95,na.rm=TRUE)[[1]]
fsm.05=quantile(db.clim$fsm,prob=0.05,na.rm=TRUE)[[1]]

mod.select.safmarg %>% 
  crossing(hsm=seq(hsm.05,
                   hsm.95,
                   length.out=400)) %>% 
  crossing(data.frame(fsm.type=c("low","indif","high"),
                      fsm=c(fsm.05,0,fsm.95))) %>% 
  mutate(fsm=case_when(fsm.type=="indif"~t_fsm,
                       TRUE~fsm)) |> 
  mutate(pred=k_int/((1+exp(-r_fsm*(fsm-t_fsm)))*
                       (1+exp(-r_hsm*(hsm-t_hsm))))) %>% 
  ggplot(aes(hsm,pred,color=fsm.type))+
  geom_line(size=1)+
  # geom_hline(aes(yintercept=prevalence))+
  facet_wrap(~species,scales="free", nrow = 3)

```

### FSM

```{r curves_sp_fsm}
mod.select.safmarg %>% 
  # for a species selection
  # filter(species%in%c("Picea abies","Fagus sylvatica","Ilex aquifolium")) %>% 
  crossing(fsm=seq(fsm.05,
                   fsm.95,
                   length.out=400)) %>% 
  crossing(data.frame(hsm.type=c("low","indif","high"),
                      hsm=c(hsm.05,0,hsm.95))) %>% 
  mutate(hsm=case_when(hsm.type=="indif"~t_hsm,
                       TRUE~hsm)) |> 
  mutate(pred=k_int/((1+exp(-r_fsm*(fsm-t_fsm)))*
                       (1+exp(-r_hsm*(hsm-t_hsm))))) %>% 
  ggplot(aes(fsm,pred,color=hsm.type))+
  geom_line(size=1)+
  # geom_hline(aes(yintercept=prevalence))+
  facet_wrap(~species,scales="free", nrow = 3)
```

## Inflexion index


```{r curve_inflex}
mod.select.safmarg %>% 
  crossing(hsm=seq(hsm.05,
                   hsm.95,
                   length.out=400)) %>% 
  crossing(data.frame(fsm.type=c("indif"),
                      fsm=c(0))) %>% 
  mutate(pred=k_int/((1+exp(-r_fsm*(fsm-t_fsm)))*
                       (1+exp(-r_hsm*(hsm-t_hsm))))) %>% 
  ggplot(aes(hsm,pred,color=inflex_hsm,linesize=species))+
  geom_line(size=0.6)+
  scale_color_gradientn(colours = viridis(15))+
  # geom_hline(aes(yintercept=prevalence))+
  # scale_y_log10()+
  theme_minimal()+
  NULL
mod.select.safmarg %>% 
    crossing(fsm=seq(fsm.05,
                     fsm.95,
                     length.out=400)) %>% 
    crossing(data.frame(hsm.type=c("indif"),
                        hsm=c(0))) %>% 
    mutate(pred=k_int/((1+exp(-r_fsm*(fsm-t_fsm)))*
                         (1+exp(-r_hsm*(hsm-t_hsm))))) %>% 
    ggplot(aes(fsm,pred,color=inflex_fsm,linesize=species))+
    geom_line(size=0.6)+
    scale_color_gradientn(colours = viridis(15))+
    # geom_hline(aes(yintercept=prevalence))+
    # scale_y_log10()+
    theme_minimal()+
  NULL
```


# Parameters / predictors

## Parameter / modtype
graph pour voir valeur des paramètres en fonction des modèles
ID: voir a quel point le choix du modèlee donne une tendance ou non dans les paramètres

```{r par_modtype}
mod.select.safmarg %>% 
  pivot_longer(cols=c("k_int","r_fsm","r_hsm","t_hsm","t_fsm"),
               names_to = "parameter",
               values_to = "val") %>% 
  filter(val!=0) %>% 
  ggplot(aes(mod,val))+
  geom_boxplot()+
  facet_wrap(~parameter,scales="free")
```


## Parameter / niche characteristics
```{r par_niche}
mod.select.safmarg %>% 
  left_join(df.species) %>% 
  # filter(!species%in%c("Picea abies","Pinus cembra","Quercus ilex","Acer monspessulanum")) %>% 
  pivot_longer(cols=c("k_int","r_fsm","r_hsm","t_hsm","t_fsm"),
               names_to = "parameter",
               values_to = "val") %>% 
  filter(!(mod=="hsm"&parameter%in%c("r_fsm","t_fsm"))) %>% 
  filter(!(mod=="fsm"&parameter%in%c("r_hsm","t_hsm"))) %>% 
  pivot_longer(cols=c("prevalence","lat.mean","lat.sd","long.mean","long.sd","lat.q05","lat.q95"),
               names_to="predictor",
               values_to = "val_pred") %>% 
  ggplot(aes(val_pred,val,color=mod))+
  geom_point()+
  geom_smooth(method="lm",aes(color=NULL))+
  facet_wrap(parameter~predictor,scales="free",nrow = 5)
```

## Predictor / modtype
```{r niche_modtype}
mod.select.safmarg %>% 
  left_join(df.species) %>% 
  pivot_longer(cols=c("prevalence","lat.mean","lat.sd","long.mean","long.sd","lat.q05","lat.q95"),
               names_to="predictor",
               values_to = "val_pred") %>% 
  ggplot(aes(mod,val_pred)) +
  geom_boxplot() +
  facet_wrap(~predictor,scales="free")


mod.select.safmarg %>% 
  left_join(df.species) %>% 
  pivot_longer(cols=c("lat.mean","lat.q05","lat.q95"),
               names_to="predictor",
               values_to = "val_pred") %>% 
  ggplot(aes(mod,val_pred)) +
  geom_boxplot() +
  facet_wrap(~predictor,scales="free")+
  theme_minimal()+
  theme(axis.title=element_blank())
```

## Parameter / species characteristics
```{r par_species}
mod.select.safmarg %>% 
  left_join(df.species) %>% 
  mutate(across(c(shade_tolerance.mean,drought_tolerance.mean,waterlogging_tolerance.mean),
                as.numeric)) %>% 
  pivot_longer(cols=c("k_int","r_fsm","r_hsm","t_hsm","t_fsm"), #,"auc"
               names_to = "parameter",
               values_to = "val") %>% 
  pivot_longer(cols=c("shade_tolerance.mean","drought_tolerance.mean","waterlogging_tolerance.mean"),
               names_to="predictor",
               values_to = "val_pred") %>% 
  filter(!(mod=="hsm"&parameter%in%c("r_fsm","t_fsm"))) %>% 
  filter(!(mod=="fsm"&parameter%in%c("r_hsm","t_hsm"))) %>% 
  ggplot(aes(val_pred,val,color=taxa))+
  geom_point()+
  geom_smooth(method="lm",aes(color=NULL))+
  facet_wrap(predictor~parameter,scales="free",nrow=3)
```

## Parameter / overlap
```{r par_overlap}
mod.select.safmarg %>% 
  filter(mod!="none") |> 
  left_join(df.species) %>% 
  pivot_longer(cols=c("k_int","inflex_fsm","inflex_hsm","t_hsm","t_fsm"),
               names_to = "parameter",
               values_to = "val") %>% 
  pivot_longer(cols=matches("overlap"),
               names_to="overlap",
               values_to = "overlap_val") %>% 
  filter(!(mod=="hsm"&parameter%in%c("inflex_fsm","t_fsm"))) %>% 
  filter(!(mod=="fsm"&parameter%in%c("inflex_hsm","t_hsm"))) %>% 
  ggplot(aes(overlap_val,val,color=mod))+
  geom_point()+
  geom_smooth(method="gam",aes(color=NULL))+
  facet_wrap(overlap~parameter,scales="free",nrow=4)
```


## Overlap shade

```{r par.shade}
mod.select.safmarg |> 
  left_join(df.species) |> 
  filter(!is.na(mod)) |> 
  select(species,mod,inflex_hsm,inflex_fsm,t_hsm,t_fsm,overlap_shade,shade_tolerance.mean) |> 
  pivot_longer(cols=c("inflex_fsm","inflex_hsm","t_hsm","t_fsm"),
               names_to = "pars",
               values_to = "pars_vals") |> 
  pivot_longer(cols=c("shade_tolerance.mean","overlap_shade"),
               names_to="predictors",
               values_to="pred_vals") |> 
  # pivot_longer(cols=c("t_hsm","t_fsm"),
  #              names_to = "threshold",
  #              values_to = "threshold_val") |> 
  filter((mod%in%c("hsm","2sm")& pars%in%c("inflex_hsm","t_hsm"))|
           (mod%in%c("fsm","2sm")&pars%in%c("inflex_fsm","t_fsm"))) |> 
  ggplot(aes(pred_vals,pars_vals))+
  geom_point()+
  geom_smooth(method="gam")+
  theme_minimal()+
  theme(axis.title=element_blank(),
        strip.placement = "outside",
        axis.line = element_line(size=0.2))+
  facet_grid(pars~predictors,
             scales="free")
```


# Inflexion analysis

## Inflexion / modtype
```{r inflex_mod}
mod.select.safmarg %>% 
  filter(mod!="none") |> 
  pivot_longer(cols=c("inflex_fsm","inflex_hsm"),
               names_to = "inflex",
               values_to="inflex_val") %>% 
  filter(!(mod=="hsm"&inflex%in%c("inflex_fsm"))) %>% 
  filter(!(mod=="fsm"&inflex%in%c("inflex_hsm"))) %>% 
  ggplot(aes(mod,inflex_val,color=mod))+
  geom_boxplot()+
    ylim(0,100)+
  scale_y_log10()+
  facet_wrap(~inflex,scales="free")

mod.select.safmarg %>% 
  rename(HSM=inflex_hsm,
         FSM=inflex_fsm) %>% 
  pivot_longer(col=c("HSM","FSM")) %>% 
  filter(mod!="none") %>% 
  filter(!(mod=="fsm"&name=="HSM")&
           !(mod=="hsm"&name=="FSM")) %>% 
  ggplot(aes(name,value))+
  geom_boxplot()+
  theme_minimal()+
  theme(axis.title.x = element_blank())+
  ylab("Inflexion index")

```
## Inflexion / niche 

```{r inflex_niche}
mod.select.safmarg %>% 
  filter(mod %in% c('fsm','2sm')) %>% 
  left_join(df.species) %>% 
  pivot_longer(cols=c("prevalence","lat.mean","lat.sd","long.mean","long.sd","lat.q05","lat.q95"),
               names_to="predictor",
               values_to = "val_pred") %>% 
  ggplot(aes(log(inflex_fsm),val_pred)) +
  geom_point() +
  geom_smooth(method="lm")+
  facet_wrap(~predictor,scales="free")
mod.select.safmarg %>% 
  filter(mod %in% c('fsm','2sm')) %>% 
  left_join(df.species) %>% 
  ggplot(aes(lat.q95,log(inflex_fsm),label=species))+
  geom_text()+
  geom_point()+
  geom_smooth(method="gam")
```

## Inflex / overlap

```{r inflex_overlap}
mod.select.safmarg %>% 
  left_join(df.species) %>% 
  pivot_longer(cols=c("overlap_drought","overlap_shade"),
               names_to="overlap",
               values_to = "overlap_val") %>% 
  pivot_longer(cols=c("inflex_fsm","inflex_hsm"),
               names_to = "inflex",
               values_to="inflex_val") %>% 
  filter(!(mod=="hsm"&inflex%in%c("inflex_fsm"))) %>% 
  filter(!(mod=="fsm"&inflex%in%c("inflex_hsm"))) %>% 
  ggplot(aes(overlap_val,log(inflex_val),color=mod))+
  geom_point()+
  geom_smooth(method="gam",aes(color=NULL))+
  facet_wrap(overlap~inflex,scales="free",nrow=4)
```

## Inflexion / shade tol
```{r inflex_shade}
#shadetol
mod.select.safmarg %>% 
  left_join(df.species) %>% 
  mutate(across(c(shade_tolerance.mean,drought_tolerance.mean,waterlogging_tolerance.mean),
                as.numeric)) %>% 
  pivot_longer(cols=c("shade_tolerance.mean","drought_tolerance.mean","waterlogging_tolerance.mean"),
               names_to="predictor",
               values_to = "val_pred") %>% 
  pivot_longer(cols=c("inflex_fsm","inflex_hsm"),
               names_to = "inflex",
               values_to="inflex_val") %>% 
  filter(!(mod=="hsm"&inflex%in%c("inflex_fsm"))) %>% 
  filter(!(mod=="fsm"&inflex%in%c("inflex_hsm"))) %>% 
  ggplot(aes(val_pred,log(inflex_val),color=taxa))+
  geom_point()+
  geom_smooth(method="lm",aes(color=NULL))+
  facet_wrap(predictor~inflex,scales="free",nrow=3)
```

## Inflexion / traits

```{r inflex_traits}

# inflexion / trait
mod.select.safmarg %>% 
  left_join(df.species) |>
  filter(mod!="none") %>% 
  select(species,px,lt50,inflex_hsm,inflex_fsm,mod) %>% 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("inflex_hsm","inflex_fsm"),names_to="inflex",values_to="inflex_val") %>% 
  filter((traits=="px"&inflex=="inflex_hsm")|
           (traits=="lt50"&inflex=="inflex_fsm")) |> 
  filter(!(mod=="hsm"&inflex=="inflex_fsm")) |> 
  filter(!(mod=="fsm"&inflex=="inflex_hsm")) |>
  ggplot(aes(traits_val,inflex_val,color=mod,label=species,shape=mod))+
  geom_point(size=3)+
  geom_text(hjust=0,vjust=0)+
  geom_smooth(method="lm",aes(color=NULL,shape=NULL,label=NULL))+
  # theme(legend.position = "none")+
  facet_wrap(~traits,scales="free")+
  theme_minimal()
```
## Inflexion / prevalence

```{r inflex_preval}
# inflexion / preval
mod.select.safmarg %>% 
  left_join(df.species) |>
  filter(mod!="none") %>% 
  select(species,prevalence,inflex_hsm,inflex_fsm,mod) %>% 
  pivot_longer(cols=c("inflex_hsm","inflex_fsm"),names_to="inflex",values_to="inflex_val") %>% 
  filter(!(mod=="fsm"&((inflex=="inflex_hsm")))&
           !(mod=="hsm"&((inflex=="inflex_fsm")))) %>% 
  ggplot(aes(prevalence,inflex_val,color=mod,label=species,shape=mod))+
  geom_point(size=3)+
  geom_text(hjust=0,vjust=0)+
  geom_smooth(method="lm",aes(color=NULL,shape=NULL,label=NULL))+
  # theme(legend.position = "none")+
  facet_wrap(~inflex,scales="free")+
  theme_minimal()
```

## Inflexion / threshold

```{r inflex_t}
# inflexion / seuil

mod.select.safmarg %>% 
  filter(mod!="none") %>% 
  select(species,t_fsm,t_hsm,inflex_hsm,inflex_fsm,mod) %>% 
  pivot_longer(cols=c("t_fsm","t_hsm"),names_to = "threshold",values_to = "threshold_val") %>% 
  pivot_longer(cols=c("inflex_hsm","inflex_fsm"),names_to="inflex",values_to="inflex_val") %>% 
  filter((threshold=="t_hsm"&inflex=="inflex_hsm")|
           (threshold=="t_fsm"&inflex=="inflex_fsm")) %>% 
  filter(!(mod=="hsm"&inflex=="inflex_fsm")) |> 
  filter(!(mod=="fsm"&inflex=="inflex_hsm")) |>
  ggplot(aes(inflex_val,threshold_val,color=mod,label=species,shape=mod))+
  geom_point(size=3)+
  geom_text(hjust=0,vjust=0)+
  geom_smooth(method="lm",aes(color=NULL,shape=NULL,label=NULL))+
  # theme(legend.position = "none")+
  facet_wrap(~inflex,scales="free")+
  theme_minimal()
```
## Inflexion /contribution

```{r inflex_contrib}
# contribution / inflexion 
mod.select.safmarg %>% 
  left_join(df.species) |>
  select(species,px,lt50,t_hsm,t_fsm,mod,inflex_fsm,inflex_hsm) %>% 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("t_fsm","t_hsm"),names_to="threshold",values_to="threshold_val") %>% 
  pivot_longer(cols=c("inflex_fsm","inflex_hsm"),names_to="inflex",values_to="inflex_val") %>% 
  filter((traits=="px"&threshold=="t_hsm"&inflex=="inflex_hsm")|
           (traits=="lt50"&threshold=="t_fsm"&inflex=="inflex_fsm")) %>% 
  filter((mod=="hsm"&threshold=="t_hsm")|
           (mod=="fsm"&threshold=="t_fsm")|
           (mod=="2sm"&threshold%in%c("t_hsm","t_fsm"))) %>% 
  mutate(contribution=100*(-traits_val-threshold_val)/(-traits_val)) %>% 
  ggplot(aes(contribution,label=species,y=inflex_val,shape=mod))+
  geom_point(size=3)+
  scale_color_gradientn(colours = terrain.colors(5))+
  geom_smooth(method="gam",aes(shape=NULL,label=NULL))+
  facet_wrap(~inflex)+
  theme_minimal()

```


# ACP
BIOMOD: mean annual, winter, and summer precipitation. Mean annual T ?C and minimum T ?C of the coldest month. Growing degree days (GDD > 5 ?C), PET

```{r clim.ACP, eval=FALSE, include=FALSE}
## build dataset
db.acp<-db.clim |> 
  select(x,y,psi,psi.100,frost.spring,frost.winter,fdg,temp.mean,pr,pet,wai) |> 
  distinct() |> 
  drop_na()

temp.winter=rast("data/CHELSA/CHELSA_bio6_1981-2010_V.2.1.tif")
names(temp.winter)="temp.winter"
prec.winter=rast("data/CHELSA/CHELSA_bio16_1981-2010_V.2.1.tif")
names(prec.winter)="prec.winter"
prec.summer=rast("data/CHELSA/CHELSA_bio17_1981-2010_V.2.1.tif")
names(prec.summer)="prec.summer"
ph=rast("data/pH_H2O.tif")
names(ph)="ph"
ph=project(ph,prec.summer)
db.acp<-cbind(db.acp,
              terra::extract(c(temp.winter,prec.summer,prec.winter),
                      data.frame(x=db.acp$x,
                                 y=db.acp$y))[-1],
              terra::extract(ph,
                             data.frame(x=db.acp$x,
                                 y=db.acp$y))[-1])

db.acp<-db.acp |> 
  mutate(across(!x&!y,
                scale)) |> 
  drop_na()

## perform acp
clim.pca=prcomp(db.acp[,c(3:10,12:15)],
                scale=FALSE)
cowplot::plot_grid(
  fviz_pca_var(clim.pca,
             axes=c(1,2),
             col.var="steelblue",
             col.circle = "grey70",
             alpha.var="contrib")+
 theme_minimal()+
  ylim(c(-1,1))+
  xlim(c(-1,1))+
  coord_equal()+
  theme(legend.position = "none",
        plot.title = element_blank()),
fviz_pca_var(clim.pca,
             axes=c(1,3),
             col.var="steelblue",
             col.circle = "grey70",
             alpha.var="contrib")+
 theme_minimal()+
  ylim(c(-1,1))+
  xlim(c(-1,1))+
  coord_equal()+
  theme(legend.position = "none",
        plot.title = element_blank()))


rm(db.acp,temp.winter,prec.winter,prec.summer,clim.pca,ph)
```





# Final figures

## Hypothesis figure

```{r hyp}
log_sfm<-function(k=0.8,
                  rh=1,
                  rf=4,
                  th=0.5,
                  tf=0.1,
                  fsm,hsm){
  k/((1+exp(-rh*(hsm-th)))*(1+exp(-rf*(fsm-tf))))
}
fsm=seq(-2,2,0.1)
hsm=seq(-2,2,0.1)
pred=outer(fsm,hsm,log_sfm,k=0.8,
                  rh=3,
                  rf=10,
                  th=0,
                  tf=-1)
plot_ly(x=hsm,y=fsm,z=pred,colors=c("black","lightgrey")) |> add_surface()

# log_sfm(fsm=fsm,hsm=hsm)
# 
# data.frame(fsm=seq(-2,2,0.1)) |> 
#   crossing(hsm=seq(-2,2,0.1)) |> 
#   mutate(pred=log_sfm(hsm=hsm,
#                       fsm=fsm) 
```

## 1st hypothesis

```{r}
predictor=c("tmin_era","psi_eraday_real","wai","pet","map","mat","prpet","sgdd")

# get climatic data and traits by species 
db.clim.lm <- db.clim |>  
  filter(presence==1) |> 
  filter(psi_eraday_real>(-15000)) |>
  left_join(margin.limit) |> 
  mutate(prpet=map-pet) |> 
  pivot_longer(cols=all_of(predictor)) |> 
  group_by(name) |> 
  mutate(value=scale(value)) |> 
  ungroup() |> 
  group_by(species,hsm.valid.3,fsm.valid.2,name,lt50,px) |> 
  summarise(quant05=quantile(value,probs=0.05,na.rm=TRUE)[[1]],
            quant5=quantile(value,probs=0.5,na.rm=TRUE)[[1]],
            quant95=quantile(value,probs=0.95,na.rm=TRUE)[[1]]) |> 
  ungroup() |> 
  mutate(lt50=scale(lt50)[,1],
         px=scale(px)[,1]) |> 
  pivot_longer(cols=c("quant05","quant5","quant95"),
               names_to="quant_name",
               values_to = "quant_val") 
  # filter(!(hsm.valid.2==FALSE&name%in%c("wai","psi","prpet","pr","pet"))) |> 
  # filter(!(fsm.valid.2==FALSE&name%in%c("sgdd","frost.winter")))

# raw dataframe
df.lm.traits<-data.frame(pred=rep(predictor,2)) |> 
  crossing(trait=c("lt50","px"),
           quant=c("quant05","quant95"),
           mean=NA,
           sd=NA,
           pval=NA,
           r2=NA,
           conf.up=NA,
           conf.low=NA,
           n=NA)


for(pred in predictor){
  print(pred)
  for(quant in c("quant05","quant95")){
    print(quant)
    
    # test for p50
    db.clim.pred<-db.clim.lm |> 
      filter(name==pred) |> 
      filter(quant_name==quant)# |> 
      # filter(hsm.valid.3==TRUE) 
      # filter(mod%in%c("2sm","hsm"))
    summary=as.data.frame(summary(lm(quant_val~px,db.clim.pred))$coefficients)
    conf=confint(lm(formula = quant_val ~ px, data = db.clim.pred))
    print(summary(lm(quant_val~px,db.clim.pred)))
    df.lm.traits[df.lm.traits$pred==pred&
                   df.lm.traits$quant==quant&
                   df.lm.traits$trait=="px",
                 c("mean","sd","pval","r2","conf.up","conf.low","n")]=
      c(summary["px",c("Estimate","Std. Error","Pr(>|t|)")],
        summary(lm(quant_val~px,db.clim.pred))$r.squared,
        conf["px",1],
        conf["px",2],
        dim(db.clim.pred)[1])
    
    
    #test for lt50
    db.clim.pred<-db.clim.lm |> 
      filter(name==pred) |> 
      filter(quant_name==quant)# |> 
      # filter(fsm.valid.2==TRUE)
      # filter(mod%in%c("2sm","fsm"))
    summary=as.data.frame(summary(lm(quant_val~lt50,db.clim.pred))$coefficients)
    conf=confint(lm(formula = quant_val ~ lt50, data = db.clim.pred))
    print(summary(lm(quant_val~lt50,db.clim.pred)))
    df.lm.traits[df.lm.traits$pred==pred&
                   df.lm.traits$quant==quant&
                   df.lm.traits$trait=="lt50",
                 c("mean","sd","pval","r2","conf.up","conf.low","n")]=
      c(summary["lt50",c("Estimate","Std. Error","Pr(>|t|)")],
        summary(lm(quant_val~lt50,db.clim.pred))$r.squared,
        conf["lt50",1],
        conf["lt50",2],
        dim(db.clim.pred)[1])
    rm(db.clim.pred)
  }
}


df.lm.traits<-df.lm.traits |> 
  mutate(signif1=pval<0.001,
         signif2=pval>0.001&pval<0.01,
         signif3=pval>0.01&pval<0.05,
         text1=ifelse(signif3,"*",
                      ifelse(signif2,"**",
                             ifelse(signif1,"***",""))),
         text2=ifelse(signif3, paste0("R2=",round(r2, digits = 2)),
                               ifelse(signif2,paste0("R2=",round(r2,digits=2)),
                                      ifelse(signif1,paste0("R2=",round(r2,digits=2)),""))))

df.lm.traits |> 
  # filter the relevant quantile for each variable (ie stressful edge)
  filter((pred%in% c("sgdd","tmin_era","psi_eraday_real","wai","prpet","map","mat") & quant=="quant05")|
           (pred=="pet"& quant=="quant95")) |>
  # filter the relevant trait for each variable
  filter((trait=="lt50"&(pred %in% c("sgdd","tmin_era","mat")))|
           (trait=="px"&(pred %in% c("wai","psi_eraday_real","prpet","map","pet")))) |> 
  # rename traits
  mutate(trait=case_when(trait=="px"~"$\\Psi_{crit}$",
                         trait=="lt50"~"$LT_{50}$")) |> 
  # filter variables
  filter(pred %in% c("mat","tmin_era","psi_eraday_real","pet","map")) |> 
  # rename
  mutate(pred=case_when(pred=="tmin_era"~"$T_{min}$",
                        pred=="psi_eraday_real"~"$\\Psi_{min}$",
                        # pred=="temp.mean"~"mat",
                        # pred=="pr"~"map",
                        TRUE~pred)) |> 
  mutate(quant=forcats::fct_recode(quant, "5%"="quant05","50%"="quant5", "95%"="quant95")) |> 
  ggplot(aes(x=mean,y=pred,color=quant))+
  geom_point(size=2.5,alpha=0.6,position=position_dodge(width=0.5))+ #,position=position_dodge(width=0.5)
  geom_pointrange(aes(xmin=conf.low,xmax=conf.up),position=position_dodge(width=0.5))+ #,position=position_dodge(width=0.5)
  geom_text(aes(label = text1,
                x=mean,
                y=pred
                ),
            # position = position_dodge(9),
            size=15/.pt,
            show.legend = FALSE,
            vjust=-0.25)+
  geom_text(aes(label = text2,
              x=mean,
              y=pred
              ),
          # position = position_dodge(9),
          size=8/.pt,
          show.legend = FALSE,
          vjust=2)+
  geom_vline(xintercept = 0,linetype="dotted")+
  scale_color_manual(values=c("darkred","lightblue"))+ 
  scale_y_discrete(label=TeX)+
  facet_wrap(~trait,
             labeller=as_labeller(TeX,
                                  default = label_parsed),
             scales = "free_y")+
  theme_minimal()+
  theme(axis.title= element_blank(),
        axis.ticks.x = element_line(linewidth = 0.6),
        axis.line.x = element_line(linewidth = 0.6),
        panel.grid = element_blank(),
        legend.position = "top",
        axis.text.y = element_text(hjust=0.5),
        text=element_text(size=11))+
  xlim(-1,1.1)+
  labs(color="Quantiles")->a

# ggsave("figures_rev/fig1_gg.pdf",
#        plot=a,
#        # scale=1,
#        dpi=600,
#        width = 9,
#        height = 8,
#        units="cm")
rm(a,df.lm.traits,summary,conf,db.clim.lm,pred,predictor,quant)
```

## mid 2 hypothesis
Generate a table with in line the type of model, and in column the proportion of species for which this model as selected.

```{r}
df.mod.results <- data.frame(Model=c("2var","fsm","hsm","none"),
                             `Eligible number`=NA,
                             Selected=NA,
                             Discarded=NA)
#2SM
mod.select.safmarg |> 
  left_join(margin.limit) |> 
  select(species,mod,hsm.valid.3,fsm.valid.2) |> 
  filter(hsm.valid.3==TRUE & fsm.valid.2==TRUE) |> 
  summarise(n=n(),
            n_select=sum(mod=="2var"),
            n_discard=n-n_select)->trans
df.mod.results[df.mod.results$Model=="2var",2:4]=trans  

#FSM
mod.select.safmarg |> 
  left_join(margin.limit) |> 
  select(species,mod,fsm.valid.2,hsm.valid.3) |> 
  filter(fsm.valid.2==TRUE) |> #&hsm.valid.3!=TRUE
  summarise(n=n(),
            n_select=sum(mod%in%c("2var","fsm")),
            n_discard=n-n_select)->trans
df.mod.results[df.mod.results$Model=="fsm",2:4]=trans  

#hSM
mod.select.safmarg |> 
  left_join(margin.limit) |> 
  select(species,mod,fsm.valid.2,hsm.valid.3) |> 
  filter(hsm.valid.3==TRUE) |> #&fsm.valid.2!=TRUE
  summarise(n=n(),
            n_select=sum(mod%in%c("2var","hsm")),
            n_discard=n-n_select)->trans
df.mod.results[df.mod.results$Model=="hsm",2:4]=trans  


#none
mod.select.safmarg |> 
  left_join(margin.limit) |> 
  select(species,mod) |> 
  summarise(n=n(),
            n_select=sum(mod%in%c("none")),
            n_discard=n-n_select)->trans
df.mod.results[df.mod.results$Model=="none",2:4]=trans

df.mod.results |> 
  mutate(Selected=round(100*Selected/Eligible.number),
         Discarded=round(100*Discarded/Eligible.number))
print(xtable(df.mod.results),include.rownames=FALSE)
rm(df.mod.results,trans)
```


## 2nd hypothesis

This figure is supposed to answer the third hypothesis which is : the species probability of presence responds non-linearly to their safety margins. This suggests that physiological thresholds of tolerance to frost and drought are responsible for abrupt decrease in probability of presence in species margins.





```{r figure1}
hsm.95=quantile(db.clim$hsm,prob=0.95,na.rm=TRUE)[[1]]
hsm.05=quantile(db.clim$hsm,prob=0.05,na.rm=TRUE)[[1]]
fsm.95=quantile(db.clim$fsm,prob=0.95,na.rm=TRUE)[[1]]
fsm.05=quantile(db.clim$fsm,prob=0.05,na.rm=TRUE)[[1]]

df.range<-db.clim |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |> 
  group_by(species) |> 
  summarise(psi_range=max(psi_eraday_real)/1000-min(psi_eraday_real)/1000,
            t_range=max(tmin_era,na.rm=TRUE)-min(tmin_era,na.rm=TRUE))

#first panel
c<-mod.select.safmarg %>%
  left_join(df.species) |>
  crossing(data.frame(xsm_val=c(seq(fsm.05,
                                    fsm.95,
                                    length.out=100),
                                seq(hsm.05,
                                    hsm.95,
                                    length.out=100)),
                      xsm_name=c(rep("Frost safety margins (°C)",100),
                                 rep("Hydraulic safety margins (MPa)",100)))) |> 
  filter((mod %in% c("2var","hsm") & xsm_name=="Hydraulic safety margins (MPa)")|
           mod %in% c("2var","fsm") & xsm_name=="Frost safety margins (°C)") |> 
  mutate(pred=case_when(mod=="2var"&xsm_name=="Hydraulic safety margins (MPa)"~k_int/((1+exp(-r_fsm*(fsm.95-t_fsm)))*
                                                            (1+exp(-r_hsm*(xsm_val-t_hsm)))),
                        mod=="2var"&xsm_name=="Frost safety margins (°C)"~k_int/((1+exp(-r_hsm*(hsm.95-t_hsm)))*
                                                            (1+exp(-r_fsm*(xsm_val-t_fsm)))),
                        mod=="hsm"~k_int/(1+exp(-r_hsm*(xsm_val-t_hsm))),
                        mod=="fsm"~k_int/(1+exp(-r_fsm*(xsm_val-t_fsm)))
                        )
         ) |>
  ggplot(aes(xsm_val,pred,color=taxa,linesize=species,linetype=mod))+ #color=prevalence,
  geom_vline(xintercept = 0,linetype="dashed")+
  geom_line(alpha=0.6,size=0.6)+
  scale_color_manual(values=c("chocolate2","forestgreen"))+
  # scale_color_gradientn(colours = viridis(15,direction=-1),
  #                       breaks=c(0,0.1,0.2,0.3,0.4,0.5,0.6))+
  guides(alpha="none")+
  labs(color="Species prevalence")+
  theme_minimal()+
  theme(axis.title= element_blank(),
        axis.ticks.x = element_line(linewidth = 0.6),
        axis.line = element_line(linewidth = 0.6),
        legend.position = "none",
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        strip.placement = "outside",
        strip.text = element_text(size=11,vjust=-1.1),
        text=element_text(size=11))+
    facet_wrap(~xsm_name,scales="free",
             strip.position = "bottom")+
  NULL

#second panel
df.n<- mod.select.safmarg %>% 
  left_join(df.species) |> 
  rename(HSM=inflex_hsm,
         FSM=inflex_fsm) %>% 
  pivot_longer(col=c("HSM","FSM")) %>% 
  filter(mod!="none") %>% 
  filter(!(mod=="fsm"&name=="HSM")&
           !(mod=="hsm"&name=="FSM")) %>% 
  group_by(taxa,name) |> 
  summarise(n=n(),
            value=quantile(value,probs=0.5)[[1]]) |> 
  ungroup() |> 
  mutate(value=case_when(name=="FSM"~95,
                         TRUE~value))
mod.select.safmarg %>%
  left_join(df.species) |> 
  mutate(HSM=inflex_hsm,
         FSM=inflex_fsm) %>% 
  pivot_longer(col=c("HSM","FSM")) %>% 
  filter(mod!="none") %>% 
  filter(!(mod=="fsm"&name=="HSM")&
           !(mod=="hsm"&name=="FSM")) %>% 
  ggplot(aes(name,value,fill=taxa))+
  geom_boxplot()+
  geom_text(data=df.n,
            mapping=aes(x=name,y=value,label=n),
            position = position_dodge(width=0.75),
            vjust=2.5,
            size=9/.pt)+
  geom_signif(comparisons = list(c("HSM","FSM")),
              map_signif_level = TRUE)+
  # geom_signif(comparisons = list(c("angiosperm","gymnosperm")),
  #             map_signif_level = TRUE)+
  # stat_compare_means(aes(label = ..p.signif..),
  #                    method = "t.test",
  #                    label.x = 1.5, label.y = 60)+
  scale_fill_manual(values=c("chocolate2","forestgreen"))+
  theme_minimal()+
  theme(axis.title.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_line(linewidth = 0.6),
        legend.title = element_blank(),
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        text=element_text(size=11))+
  labs(x="Inflexion index")-> b
#%%%%%%%%%%%%%%%%%%%
#third panel
df.n<- mod.select.safmarg %>% 
  left_join(df.species) |>
    left_join(df.range) |> 
    dplyr::select(species,px,lt50,t_hsm,t_fsm,mod,psi_range,t_range,taxa) %>% 
    mutate(t_range=case_when(is.na(t_range)~mean(df.range$t_range,na.rm=TRUE),
                           TRUE~t_range),
         HSM=t_hsm/psi_range,
         FSM=t_fsm/t_range) |> 
  dplyr::select(taxa,species,mod,HSM,FSM) %>% 
  pivot_longer(cols=c("HSM","FSM"),names_to = "threshold",values_to = "traits_val") %>% 
  filter((mod%in%c("hsm","2var")&threshold=="HSM")|
           (mod%in%c("fsm","2var")&threshold=="FSM")) %>% 
  group_by(taxa,threshold) |> 
  summarise(n=n(),
            value=quantile(traits_val,probs=0.5)[[1]]) |> 
  ungroup()
mod.select.safmarg %>% 
  left_join(df.species) |>
  left_join(df.range) |> 
  dplyr::select(species,px,lt50,t_hsm,t_fsm,mod,psi_range,t_range,taxa) %>% 
  mutate(t_range=case_when(is.na(t_range)~mean(df.range$t_range,na.rm=TRUE),
                           TRUE~t_range),
         `HSM`=t_hsm/psi_range,
         FSM=t_fsm/t_range) |> 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("HSM","FSM"),names_to="threshold",values_to="threshold_val") %>% 
  filter((mod%in%c("hsm","2var")&traits=="px"&threshold=="HSM")|
           (mod%in%c("fsm","2var")&traits=="lt50"&threshold=="FSM")) %>% 
  group_by(threshold) |> 
  mutate(n=n()) |> 
  ungroup() |> 
  ggplot(aes(threshold,threshold_val,fill=taxa))+
  geom_boxplot()+
  geom_text(data=df.n,
            mapping=aes(x=threshold,y=value,label=n),
            position = position_dodge(width=0.75),
            vjust=-0.5,
            size=8/.pt)+
  geom_signif(comparisons = list(c("HSM","FSM")),
              map_signif_level = TRUE)+
  # geom_text(data=df.n,mapping=aes(x=threshold,y=threshold_val,label=n))+
  # stat_compare_means(aes(label = ..p.signif..),
  #                    method = "t.test",
  #                    label.x = 1.5, label.y = 0.35)+
  scale_fill_manual(values=c("chocolate2","forestgreen"))+
  theme_minimal()+
  theme(axis.title.y= element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_line(linewidth = 0.6),
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        strip.placement = "outside",
        text=element_text(size=11))+
  labs(x="Rescaled thresholds")+
  NULL-> a

cowplot::plot_grid(
  c,
  cowplot::plot_grid(get_legend(b),
                   cowplot::plot_grid(a+theme(legend.position = "none"),
                                      b+theme(legend.position = "none"),
                                      nrow=1),
                   nrow=2,
                   rel_heights = c(0.2,1),
                   rel_widths = c(0.2,1),
                   axis="l"
                   ),
  labels=c("A","B"),
  label_size = 12,
  hjust=c(-0.2,0.51),
  rel_widths = c(1.1,0.6)
)->plot
plot
# ggsave(filename = "hyp1.png",
#        plot, 
#        width=10,
#        height = 6)
ggsave("figures_rev/fig2_gg_2.pdf",
       plot=plot,
       scale=1,
       dpi=600,
       width = 19.5,
       height = 12,
       units="cm")

                                  
```

## 3rd hypothesis

```{r fig3}
predictor=c("overlap_drought","overlap_shade") #,"lat.mean"
df.mod.overlap=mod.select.safmarg |> 
  left_join(df.species) |> 
  left_join(margin.limit) |> 
  select(taxa,species,
         matches(c("inflex","^t_")),
         hsm.valid.3,fsm.valid.2,
         overlap_drought,overlap_shade,lat.mean,
         mod) |> 
  mutate(across(matches("inflex"),
                ~100-.)) |> 
  pivot_longer(cols=c("overlap_drought","overlap_shade"), #,"lat.mean"
               names_to = "pred",
               values_to = "pred_val") |> 
  # group_by(pred) |> mutate(pred_val=scale(pred_val)) |>
  pivot_longer(cols=matches(c("inflex","t_")),
               names_to = "par",
               values_to = "par_val")# |>
  # group_by(par) |>  mutate(par_val=scale(par_val))

df.lm.overlap<-data.frame(pred=rep(predictor,2)) |> 
  crossing(par=c("inflex_fsm","inflex_hsm","t_hsm","t_fsm"),
           mean=NA,
           sd=NA,
           pval=NA,
           conf.up=NA,
           conf.low=NA)


for(preds in predictor){
  print(preds)
  for(pars in c("inflex_fsm","inflex_hsm","t_hsm","t_fsm")){
    print(pars)
    df.mod.pred<-df.mod.overlap |>
      filter(pred==preds) |>
      filter(par==pars) |> 
      filter(!is.na(par_val)&
               !is.na(pred_val)) #|> 
      # mutate(par_val=scale(par_val),
      #        pred_val=scale(pred_val))
    if(grepl("hsm",pars)){
      df.mod.pred<-df.mod.pred |>
        # filter(hsm.valid.3==TRUE) |> 
        filter(mod%in%c("2var","hsm"))|>
        mutate(par_val=scale(par_val),
               pred_val=scale(pred_val))
    }else{
      df.mod.pred<-df.mod.pred |>
        # filter(fsm.valid.2==TRUE) |> 
        filter(mod%in%c("2var","fsm")) |>
        mutate(par_val=scale(par_val),
               pred_val=scale(pred_val))
    }
    summary=as.data.frame(summary(lm(par_val~pred_val,df.mod.pred))$coefficients)
    conf=confint(lm(formula = par_val~pred_val, data = df.mod.pred))
    print(summary(lm(par_val~pred_val,df.mod.pred)))
    df.lm.overlap[df.lm.overlap$pred==preds&
                   df.lm.overlap$par==pars,
                 c("mean","sd","pval","conf.up","conf.low")]=
      c(summary["pred_val",c("Estimate","Std. Error","Pr(>|t|)")],
        conf["pred_val",1],
        conf["pred_val",2])
  }
}


df.lm.overlap<-df.lm.overlap |> 
  mutate(signif1=pval<0.001,
         signif2=pval>0.001&pval<0.01,
         signif3=pval>0.01&pval<0.05)

df.lm.overlap |> 
  # mutate(quant=recode(quant, quant05 = "5%", quant95 = "95%")) |> 
  mutate(pred=case_when(pred=="overlap_drought"~"Competitive dominance  \nfor drought tolerance",
                        pred=="overlap_shade"~"Competitive dominance  \nfor shade tolerance")
         ) |> 
  separate(col = par,
           sep="_", into=c("par","mod")) |> 
  mutate(par=case_when(par=="inflex"~"Inflexion index \n I",
                       par=="t"~"Threshold \n t")) |> 
  ggplot(aes(x=mean,y=par,color=mod))+
  scale_color_manual(values=c("lightblue","darkred"))+
  geom_point(size=2.5,alpha=0.6,position=position_dodge(width=0.5))+ 
  geom_pointrange(aes(xmin=conf.low,xmax=conf.up),position=position_dodge(width=0.5))+ 
  geom_text(aes(label = ifelse(signif3, "*",
                               ifelse(signif2,"**",
                                      ifelse(signif3,"***",""))),
                x=mean),
            size=8,
            show.legend = FALSE,
            vjust=0.75)+
  geom_vline(xintercept = 0,linetype="dotted")+
  theme_minimal()+
  facet_wrap(~pred)+
  theme(axis.title= element_blank(),
        axis.ticks.x = element_line(linewidth = 0.6),
        axis.line.x = element_line(linewidth = 0.6),
        panel.grid = element_blank(),
        # legend.position = "top",
        legend.title=element_blank(),
        text=element_text(size=11),
        axis.text.y = element_text(hjust=0.5)) -> plot3
ggsave("figures_rev/fig_si3.pdf",
       plot=plot3,
       dpi=600,
       width = 13,
       height = 8,
       units="cm")
```

## 4th hypothesis
```{r}

# lat.range<-db.clim |> 
#   filter(presence==1) |> 
#   group_by(species) |> 
#   summarise(lat_range=max(y)-min(y),
#             long_range=max(x)-min(x))
# 

library(pROC)
# load("mod new/fit_random_allsp.RData")
# load("fit_random_allspClim.RData")

load("mod_last_vers/fit_random_allsp.RData")
load("mod_last_vers/fit_random_allspClim.RData")
# load("mod new/fit_random_allspClim.RData")

posteriors_mean_clim<-as.data.frame(t(summary(fit.allspClim)$summary)) |> 
    select(!matches("K_sp"))
posteriors_mean_sfm<-as.data.frame(t(summary(fit.allsp)$summary)) |> 
    select(!matches("K_sp"))
db.clim.auc<-db.clim |> 
  filter(!is.na(px)|!is.na(lt50)) |> 
    # filter(species.binomial==sp) |> 
    select(species,presence,x,y,hsm,fsm,mat,map) |> 
    mutate(pred_sfm=posteriors_mean_sfm$K_int[1]/
             ((1+exp(-posteriors_mean_sfm$r_fsm[1]*(fsm-posteriors_mean_sfm$t_fsm[1])))*
                (1+exp(-posteriors_mean_sfm$r_hsm[1]*(hsm-posteriors_mean_sfm$t_hsm[1])))),
           pred_clim=posteriors_mean_clim$K_int[1]/
             ((1+exp(-posteriors_mean_clim$r_mat[1]*(mat-posteriors_mean_clim$t_mat[1])))*
                (1+exp(-posteriors_mean_clim$r_wai[1]*(map-posteriors_mean_clim$t_wai[1])))),
           tss_clim=NA,
           tss_sfm=NA,
           thres_clim=NA,
           thres_sfm=NA
    ) |> 
    group_by(species) |> 
    summarize(auc_sfm=as.numeric(auc(presence,pred_sfm)),
              auc_clim=as.numeric(auc(presence,pred_clim))) 
db.clim.auc |> 
  filter(auc_clim>0.6) |> 
  mutate(dif=auc_sfm-auc_clim) |>
  summary()

db.clim.auc |> 
  mutate(dif=auc_sfm>auc_clim) |> 
  summary()

db.clim.auc |> 
  left_join(lat.range) |> 
  ggplot(aes(auc_clim,lat_range))+
  geom_point()+
  geom_smooth()
species.clim=db.clim.auc |> 
  filter(auc_clim>auc_sfm) |>
  pull(species)


# map predictions
# node.samp=db.clim |> select(node,x,y) |> unique()
sp="Abies alba"
n_samp=dim(db.clim[db.clim$species==sp&db.clim$presence==1,])[1]
db.clim |> 
  filter(species==sp) |> 
  filter(!is.na(hsm)) |> 
  filter(!is.na(fsm)) |> 
  filter(!is.na(map)) |> 
  # filter(node %in% node.samp) |> 
  mutate(pred_sfm=posteriors_mean_sfm$K_int[1]/
             ((1+exp(-posteriors_mean_sfm$r_fsm[1]*(fsm-posteriors_mean_sfm$t_fsm[1])))*
                (1+exp(-posteriors_mean_sfm$r_hsm[1]*(hsm-posteriors_mean_sfm$t_hsm[1])))),
          pred_clim=posteriors_mean_clim$K_int[1]/
             ((1+exp(-posteriors_mean_clim$r_mat[1]*(mat-posteriors_mean_clim$t_mat[1])))*
                (1+exp(-posteriors_mean_clim$r_wai[1]*(wai-posteriors_mean_clim$t_wai[1]))))
  ) |> 
  select(x,y,presence,pred_clim,pred_sfm) |> 
  # filter(log(pred_clim)>(-5)) |> 
  # group_by(presence) |>
  # slice_sample(n=n_samp) |>
  # filter(presence==1) |>
  pivot_longer(cols=c("pred_clim","pred_sfm","presence")) |>
  ggplot()+
  # geom_point(data=node.samp,aes(x=x,y=y),color="grey",size=0.5,alpha=0.4)+
  geom_point(aes(x=x,y=y,color=value),size=0.5,alpha=0.8)+
  xlim(c(-5,25))+
  ylim(c(35,55))+
  scale_color_gradientn(colours = viridis(15,direction=-1))+
  facet_wrap(~name)

db.clim |> 
  filter(species%in%species.clim[c(1,5,7,12,13)]) |> 
  filter(!is.na(hsm)) |> 
  filter(!is.na(fsm)) |> 
  filter(!is.na(map)) |> 
  # filter(node %in% node.samp) |> 
  mutate(pred_sfm=posteriors_mean_sfm$K_int[1]/
             ((1+exp(-posteriors_mean_sfm$r_fsm[1]*(fsm-posteriors_mean_sfm$t_fsm[1])))*
                (1+exp(-posteriors_mean_sfm$r_hsm[1]*(hsm-posteriors_mean_sfm$t_hsm[1])))),
          pred_clim=posteriors_mean_clim$K_int[1]/
             ((1+exp(-posteriors_mean_clim$r_mat[1]*(mat-posteriors_mean_clim$t_mat[1])))*
                (1+exp(-posteriors_mean_clim$r_wai[1]*(wai-posteriors_mean_clim$t_wai[1]))))
  ) |> 
  select(x,y,species,presence,pred_clim,pred_sfm) |>
  pivot_longer(cols=c("pred_clim","pred_sfm","presence")) |>
  ggplot()+
  # geom_point(data=node.samp,aes(x=x,y=y),color="grey",size=0.5,alpha=0.4)+
  geom_point(aes(x=x,y=y,color=value),size=0.5,alpha=0.8)+
  xlim(c(-5,25))+
  ylim(c(35,55))+
  scale_color_gradientn(colours = viridis(15,direction=1))+
  facet_grid(name~species)->plot


## compute tss
pred= db.clim |> 
  # filter(species==sp) |> 
  filter(!is.na(hsm)) |> 
  filter(!is.na(fsm)) |> 
  filter(!is.na(map)) |> 
  # filter(node %in% node.samp) |> 
  mutate(pred_sfm=posteriors_mean_sfm$K_int[1]/
             ((1+exp(-posteriors_mean_sfm$r_fsm[1]*(fsm-posteriors_mean_sfm$t_fsm[1])))*
                (1+exp(-posteriors_mean_sfm$r_hsm[1]*(hsm-posteriors_mean_sfm$t_hsm[1])))),
          pred_clim=posteriors_mean_clim$K_int[1]/
             ((1+exp(-posteriors_mean_clim$r_mat[1]*(mat-posteriors_mean_clim$t_mat[1])))*
                (1+exp(-posteriors_mean_clim$r_wai[1]*(map-posteriors_mean_clim$t_wai[1]))))
  ) 
# Function to calculate TSS
calc_tss <- function(threshold, observed, predicted_probs) {
  observed=as.factor(observed)
  predicted <- ifelse(predicted_probs > threshold, 1, 0)
  predicted=factor(predicted,levels=c(0,1))
  conf_matrix <- table(observed, predicted)
  TP <- conf_matrix[2, 2]
  FN <- conf_matrix[2, 1]
  TN <- conf_matrix[1, 1]
  FP <- conf_matrix[1, 2]
  sensitivity <- TP / (TP + FN)
  specificity <- TN / (TN + FP)
  TSS <- sensitivity + specificity - 1
  return(TSS)
}
for (sp in db.clim.auc$species){
  print(sp)
  observed <- pred[pred$species==sp,"presence"]

  #sfm
  predicted_sfm <- pred[pred$species==sp,"pred_sfm"]
  threshold_max=posteriors_mean_sfm$K_int[1]
  thresholds <- seq(0,threshold_max, length.out=100)
  tss_sfm <- sapply(thresholds, calc_tss, observed,predicted_sfm)
  db.clim.auc[db.clim.auc$species==sp,c("tss_sfm","thres_sfm")]=list(max(tss_sfm),
                                                                     thresholds[which.max(tss_sfm)])
  #clim
  predicted_clim <- pred[pred$species==sp,"pred_clim"]
  threshold_max=posteriors_mean_clim$K_int[1]
  thresholds <- seq(0,threshold_max, length.out=100)
  tss_clim <- sapply(thresholds, calc_tss, observed,predicted_clim)
  db.clim.auc[db.clim.auc$species==sp,c("tss_clim","thres_clim")]=list(max(tss_clim),
                                                                     thresholds[which.max(tss_clim)])

}
db.clim.auc<-db.clim.auc |> 
  mutate(tss_sup=tss_sfm>tss_clim,
         auc_sup=auc_sfm>auc_clim)
summary(db.clim.auc)

## TSS for general model
threshold_max=posteriors_mean_clim$K_int[1]
thresholds <- seq(0,threshold_max, length.out=100)
tss_clim <- sapply(thresholds,
                   calc_tss, 
                   pred[pred$species==sp,"presence"],
                   pred[pred$species==sp,"pred_clim"])
print(max(tss_clim))
threshold_max=posteriors_mean_sfm$K_int[1]
thresholds <- seq(0,threshold_max, length.out=100)
tss_sfm <- sapply(thresholds,
                   calc_tss, 
                   pred[pred$species==sp,"presence"],
                   pred[pred$species==sp,"pred_sfm"])
print(max(tss_sfm))
```

```{r}
tar_read(mod.select.clim) |> select(species,mod,auc) |> 
  rename_with(.cols=c("mod","auc"),
              ~paste0(.,"_clim")) |> 
  left_join(mod.select.safmarg[,c("species","mod","auc")] |> 
              rename_with(.cols=c("mod","auc"),
              ~paste0(.,"_safmar"))) |> 
  mutate(dif=auc_safmar-auc_clim) |> 
  filter(dif>(-0.05))
```

## Supplementary mat

### 1st hp
```{r}
db.clim |> 
  # mutate(px=-px,
  #    lt50=-lt50,
  #    psi_eraday_real=-psi_eraday_real,
  #    wai=-wai) |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |>
  pivot_longer(cols=c("tmin_era","psi_eraday_real","pet","mat","map")) |> 
  mutate(name=case_when(name=="tmin_era"~"$T_{min}$",
                        name=="psi_eraday_real"~"$\\Psi_{min}$",
                        TRUE~name)) |> 
  group_by(name) |> 
  # mutate(value=scale(value)) |> 
  ungroup() |> 
  group_by(species,name,lt50) |> 
  summarise(`5%`=quantile(value,probs=0.05,na.rm=TRUE),
            `95%`=quantile(value,probs=0.95,na.rm=TRUE)) |> 
  pivot_longer(cols=c("5%","95%"),
               names_to = "Quantile",
               values_to = "val") |> 
  ggplot(aes(lt50,val,color=Quantile))+
  geom_point()+
  geom_smooth(method="gam")+
  scale_color_manual(values=c("darkred","lightblue"))+
  theme_minimal()+
  labs(x="LT50")+
  theme(axis.title.y = element_blank(),
        text = element_text(size=11))+
  facet_wrap(~name,
             labeller=as_labeller(TeX,
                                  default = label_parsed),
             scales="free")->a
ggsave("figures_rev/fig_si1.pdf",
       plot=a,
       # scale=1,
       dpi=600,
       width = 19,
       height = 12,
       units="cm")

db.clim |> 
  # mutate(px=-px,
  #    lt50=-lt50,
  #    psi_eraday_real=-psi_eraday_real,
  #    wai=-wai) |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |>
  pivot_longer(cols=c("tmin_era","psi_eraday_real","pet","mat","map")) |> 
  mutate(name=case_when(name=="tmin_era"~"$T_{min}$",
                        name=="psi_eraday_real"~"$\\Psi_{min}$",
                        TRUE~name)) |> 
  group_by(name) |> 
  # mutate(value=scale(value)) |> 
  ungroup() |> 
  group_by(species,name,p50) |> 
  summarise(`5%`=quantile(value,probs=0.05,na.rm=TRUE),
            `95%`=quantile(value,probs=0.95,na.rm=TRUE)) |> 
  pivot_longer(cols=c("5%","95%"),
               names_to = "Quantile",
               values_to = "val") |> 
  ggplot(aes(p50,val,color=Quantile))+
  geom_point()+
  geom_smooth(method="gam")+
  scale_color_manual(values=c("darkred","lightblue"))+
  theme_minimal()+
  labs(x="P50")+
  theme(axis.title.y = element_blank(),
        text = element_text(size=11))+
  facet_wrap(~name,
             labeller=as_labeller(TeX,
                                  default = label_parsed),
             scales="free")->a
a
ggsave("figures_rev/fig_si2.pdf",
       plot=a,
       # scale=1,
       dpi=600,
       width = 19,
       height = 12,
       units="cm")
```

### Model output
```{r}
mod.select.safmarg |> 
  left_join(margin.limit) |> 
  left_join(df.species) |> 
  relocate(mod, .after = "species") |> 
  select(species,n,mod,prevalence,k_int,r_fsm,t_fsm,r_hsm,t_hsm,inflex_fsm,inflex_hsm,fsm.valid.2,hsm.valid.3,shade_tolerance.mean,overlap_shade) |>  #drought_tolerance.mean,,overlap_drought
  mutate(across(is.numeric,~round(.,digits = 2)),
         across(matches("_hsm"),~case_when(mod=="fsm"~NA,TRUE~.)),
         across(matches("_fsm"),~case_when(mod=="hsm"~NA,TRUE~.))) |> 
  rename(`Shade tolerance`="shade_tolerance.mean",
         # `Drought tolerance`="drought_tolerance.mean",
         Model="mod",
         Species="species",
         I_fsm="inflex_fsm",
         I_hsm="inflex_hsm",
         `Data FSM`="fsm.valid.2",
         `Data HSM`="hsm.valid.3",
         # `Drought cdi`="overlap_drought",
         `Shade cdi`="overlap_shade") ->t
  print(xtable(t),include.rownames=FALSE)

  
  
```

### Soil sensisitivity analysis


```{r figure1}
hsm.95=quantile(db.clim$hsm,prob=0.95,na.rm=TRUE)[[1]]
hsm.05=quantile(db.clim$hsm,prob=0.05,na.rm=TRUE)[[1]]
fsm.95=quantile(db.clim$fsm,prob=0.95,na.rm=TRUE)[[1]]
fsm.05=quantile(db.clim$fsm,prob=0.05,na.rm=TRUE)[[1]]

df.range<-db.clim |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |> 
  group_by(species) |> 
  summarise(psi_range=max(psi_eraday_real)/1000-min(psi_eraday_real)/1000,
            t_range=max(tmin_era,na.rm=TRUE)-min(tmin_era,na.rm=TRUE))

#first panel
c<-mod.select.safmarg_beta %>%
  left_join(df.species) |>
  crossing(data.frame(xsm_val=c(seq(fsm.05,
                                    fsm.95,
                                    length.out=100),
                                seq(hsm.05,
                                    hsm.95,
                                    length.out=100)),
                      xsm_name=c(rep("Frost safety margins (°C)",100),
                                 rep("Hydraulic safety margins (MPa)",100)))) |> 
  filter((mod %in% c("2var","hsm") & xsm_name=="Hydraulic safety margins (MPa)")|
           mod %in% c("2var","fsm") & xsm_name=="Frost safety margins (°C)") |> 
  mutate(pred=case_when(mod=="2var"&xsm_name=="Hydraulic safety margins (MPa)"~k_int/((1+exp(-r_fsm*(fsm.95-t_fsm)))*
                                                            (1+exp(-r_hsm*(xsm_val-t_hsm)))),
                        mod=="2var"&xsm_name=="Frost safety margins (°C)"~k_int/((1+exp(-r_hsm*(hsm.95-t_hsm)))*
                                                            (1+exp(-r_fsm*(xsm_val-t_fsm)))),
                        mod=="hsm"~k_int/(1+exp(-r_hsm*(xsm_val-t_hsm))),
                        mod=="fsm"~k_int/(1+exp(-r_fsm*(xsm_val-t_fsm)))
                        )
         ) |>
  ggplot(aes(xsm_val,pred,color=taxa,linesize=species,linetype=mod))+ #color=prevalence,
  geom_vline(xintercept = 0,linetype="dashed")+
  geom_line(alpha=0.6,size=0.6)+
  scale_color_manual(values=c("chocolate2","forestgreen"))+
  # scale_color_gradientn(colours = viridis(15,direction=-1),
  #                       breaks=c(0,0.1,0.2,0.3,0.4,0.5,0.6))+
  guides(alpha="none")+
  labs(color="Species prevalence")+
  theme_minimal()+
  theme(axis.title= element_blank(),
        axis.ticks.x = element_line(linewidth = 0.6),
        axis.line = element_line(linewidth = 0.6),
        legend.position = "none",
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        strip.placement = "outside",
        strip.text = element_text(size=11,vjust=-1.1),
        text=element_text(size=11))+
    facet_wrap(~xsm_name,scales="free",
             strip.position = "bottom")+
  NULL

#second panel
df.n<- mod.select.safmarg_beta %>% 
  left_join(df.species) |> 
  rename(HSM=inflex_hsm,
         FSM=inflex_fsm) %>% 
  pivot_longer(col=c("HSM","FSM")) %>% 
  filter(mod!="none") %>% 
  filter(!(mod=="fsm"&name=="HSM")&
           !(mod=="hsm"&name=="FSM")) %>% 
  group_by(taxa,name) |> 
  summarise(n=n(),
            value=quantile(value,probs=0.5)[[1]]) |> 
  ungroup()
mod.select.safmarg_beta %>%
  left_join(df.species) |> 
  mutate(HSM=inflex_hsm,
         FSM=inflex_fsm) %>% 
  pivot_longer(col=c("HSM","FSM")) %>% 
  filter(mod!="none") %>% 
  filter(!(mod=="fsm"&name=="HSM")&
           !(mod=="hsm"&name=="FSM")) %>% 
  ggplot(aes(name,value,fill=taxa))+
  geom_boxplot()+
  geom_text(data=df.n,
            mapping=aes(x=name,y=value,label=n),
            position = position_dodge(width=0.75),
            vjust=2.5,
            size=9/.pt)+
  geom_signif(comparisons = list(c("HSM","FSM")),
              map_signif_level = TRUE)+
  # geom_signif(comparisons = list(c("angiosperm","gymnosperm")),
  #             map_signif_level = TRUE)+
  # stat_compare_means(aes(label = ..p.signif..),
  #                    method = "t.test",
  #                    label.x = 1.5, label.y = 60)+
  scale_fill_manual(values=c("chocolate2","forestgreen"))+
  theme_minimal()+
  theme(axis.title.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_line(linewidth = 0.6),
        legend.title = element_blank(),
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        text=element_text(size=11))+
  labs(x="Inflexion index")-> b
#%%%%%%%%%%%%%%%%%%%
#third panel
df.n<- mod.select.safmarg_beta %>% 
  left_join(df.species) |>
    left_join(df.range) |> 
    dplyr::select(species,px,lt50,t_hsm,t_fsm,mod,psi_range,t_range,taxa) %>% 
    mutate(t_range=case_when(is.na(t_range)~mean(df.range$t_range,na.rm=TRUE),
                           TRUE~t_range),
         HSM=t_hsm/psi_range,
         FSM=t_fsm/t_range) |> 
  dplyr::select(taxa,species,mod,HSM,FSM) %>% 
  pivot_longer(cols=c("HSM","FSM"),names_to = "threshold",values_to = "traits_val") %>% 
  filter((mod%in%c("hsm","2var")&threshold=="HSM")|
           (mod%in%c("fsm","2var")&threshold=="FSM")) %>% 
  group_by(taxa,threshold) |> 
  summarise(n=n(),
            value=quantile(traits_val,probs=0.5)[[1]]) |> 
  ungroup()
mod.select.safmarg_beta %>% 
  left_join(df.species) |>
  left_join(df.range) |> 
  dplyr::select(species,px,lt50,t_hsm,t_fsm,mod,psi_range,t_range,taxa) %>% 
  mutate(t_range=case_when(is.na(t_range)~mean(df.range$t_range,na.rm=TRUE),
                           TRUE~t_range),
         `HSM`=t_hsm/psi_range,
         FSM=t_fsm/t_range) |> 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("HSM","FSM"),names_to="threshold",values_to="threshold_val") %>% 
  filter((mod%in%c("hsm","2var")&traits=="px"&threshold=="HSM")|
           (mod%in%c("fsm","2var")&traits=="lt50"&threshold=="FSM")) %>% 
  group_by(threshold) |> 
  mutate(n=n()) |> 
  ungroup() |> 
  ggplot(aes(threshold,threshold_val,fill=taxa))+
  geom_boxplot()+
  geom_text(data=df.n,
            mapping=aes(x=threshold,y=value,label=n),
            position = position_dodge(width=0.75),
            vjust=-0.5,
            size=8/.pt)+
  geom_signif(comparisons = list(c("HSM","FSM")),
              map_signif_level = TRUE)+
  # geom_text(data=df.n,mapping=aes(x=threshold,y=threshold_val,label=n))+
  # stat_compare_means(aes(label = ..p.signif..),
  #                    method = "t.test",
  #                    label.x = 1.5, label.y = 0.35)+
  scale_fill_manual(values=c("chocolate2","forestgreen"))+
  theme_minimal()+
  theme(axis.title.y= element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_line(linewidth = 0.6),
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        strip.placement = "outside",
        text=element_text(size=11))+
  labs(x="Rescaled thresholds")+
  NULL-> a


cowplot::plot_grid(
  c,
  cowplot::plot_grid(get_legend(b),
                   cowplot::plot_grid(a+theme(legend.position = "none"),
                                      b+theme(legend.position = "none"),
                                      nrow=1),
                   nrow=2,
                   rel_heights = c(0.2,1),
                   rel_widths = c(0.2,1),
                   axis="l"
                   ),
  labels=c("A","B"),
  label_size = 12,
  hjust=c(-0.2,0.51),
  rel_widths = c(1.1,0.6)
)->plot
plot
# ggsave(filename = "hyp1.png",
#        plot, 
#        width=10,
#        height = 6)
ggsave("figures_rev/fig_si4.pdf",
       plot=plot,
       scale=1,
       dpi=600,
       width = 19.5,
       height = 12,
       units="cm")

                                  
```

### Indicators 

```{r}
tmin=rast(tar_read(tmin2m_era,store="target_data"))
names(tmin)="tmin"
as.data.frame(tmin,
              xy=TRUE) |> 
  mutate(tmin=cut(tmin,
                 breaks=c(-Inf, -50,-40, -30,-20,-15,-10,-5,0,Inf),
                 labels=c("<-50", "-50<Tmin<-40","-40/-30","-30/-20","-20/-15","-15/-10","-10/-5",
                          "-5/0",">0"))) %>%
  ggplot() +
  geom_tile(aes(x=x,y=y,fill=tmin))+
  geom_sf(data=europe,
                  fill=NA)+
  coord_sf()+
  theme_minimal() +
  labs(fill="Tmin")+
  theme(axis.title=element_blank(),
        axis.text = element_blank(),
        legend.key.size = unit(0.5,"cm"),
        legend.text = element_text(size=8),
        legend.title = element_text(size=9))+
          scale_fill_brewer(palette="RdYlBu")->a

ggsave("figures_rev/fig_si_tmin.pdf",
       plot=a,
       scale=1,
       dpi=600,
       width = 12,
       height = 15,
       units="cm")
```



Varying beta
```{r}
psi=aggregate(c(rast(tar_read(psi_eradaycdo_real_beta,store="target_psi2")[,c("x","y","psi")]),
                rast(tar_read(psi_eradaycdo_real,store="target_psi2")[,c("x","y","psi")])),
              10,
              method="mean",
              na.rm=TRUE)
names(psi)=c("psi_beta","psi_real")


as.data.frame(psi) |> 
  mutate(ssy=((psi_beta-psi_real)/abs(psi_beta))) |> 
  summarise(ssy=median(ssy,na.rm=TRUE),
            cor=cor(psi_beta,psi_real, use="pairwise.complete.obs"),
            rmse=exp(sqrt(mean((log(-psi_beta)-log(-psi_real))^2,na.rm=TRUE))))

t_test=as.data.frame(psi) |> 
  mutate(ssy=((psi_beta-psi_real)/abs(psi_beta))) |> 
  drop_na() |> 
  summarise(t.test=t.test(psi_beta,psi_real)$p.value)


as.data.frame(psi,xy=TRUE)|>
    mutate(dif=cut(psi_real-psi_beta,
                 breaks=c(-Inf, -2000, -1000, -500, -250, 0, 250,500,1000,2000,Inf))#,
           # psi_beta=cut(psi_beta,
           #       breaks=c(-Inf, -15000, -10000, -5000,-3000, -2000, -1000, -500, 0,Inf),
           #               labels=c("<-15MPa","-15<HSM<-10MPa","-10<HSM<-5MPa",
           #                        "-5<psi<-3MPa","-3/-2","-2/-1","-1/-0.5","-0.5/0", ">0MPa")),
           ) |> 
  # pivot_longer(cols=c("psi_real","psi_beta")) |> 
  ggplot()+
  geom_tile(aes(x=x,y=y,fill=dif))+
  geom_sf(data=europe,
                  fill=NA)+
  coord_sf()+
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text = element_blank(),
        legend.key.size = unit(0.5,"cm"),
        legend.text = element_text(size=10),
        legend.title = element_text(size=11))+
  scale_fill_brewer(palette="RdYlBu")+
  labs(fill=unname(TeX("$\\Psi_{min}-\\Psi_{new}(MPa)$")))-> a

ggsave("figures_rev/fig_si_beta.pdf",
       plot=a,
       scale=1,
       dpi=600,
       width = 12,
       height = 15,
       units="cm")
  # facet_wrap(~name)
```


Varying lai
```{r}
psi=aggregate(c(rast(tar_read(sensitivity_2_0.966,store="target_psi2")[,c("x","y","psi")]),
                rast(tar_read(sensitivity_3_0.966,store="target_psi2")[,c("x","y","psi")]),
                rast(tar_read(sensitivity_4_0.966,store="target_psi2")[,c("x","y","psi")]),
                rast(tar_read(sensitivity_5_0.966,store="target_psi2")[,c("x","y","psi")]),
                rast(tar_read(sensitivity_6_0.966,store="target_psi2")[,c("x","y","psi")]),
                rast(tar_read(sensitivity_7_0.966,store="target_psi2")[,c("x","y","psi")]),
                rast(tar_read(sensitivity_8_0.966,store="target_psi2")[,c("x","y","psi")])
                ),
              10,
              method="mean",
              na.rm=TRUE)
names(psi)=c("psi_2","psi_3","psi_4","psi_5","psi_6","psi_7","psi_8")

## summary stats
as.data.frame(psi,xy=TRUE)|>
  pivot_longer(cols=c("psi_2","psi_3","psi_4","psi_6","psi_7","psi_8")) |> 
  mutate(ssy=((psi_5-value)/abs(psi_5))) |> 
  group_by(name) |> 
  summarise(ssy=median(ssy,na.rm=TRUE),
            cor=cor(value,psi_5, use="pairwise.complete.obs"),
            rmse=exp(sqrt(mean((log(-value)-log(-psi_5))^2,na.rm=TRUE))))
    
t_test=as.data.frame(psi,xy=TRUE)|>
  pivot_longer(cols=c("psi_2","psi_3","psi_4","psi_6","psi_7","psi_8")) |> 
  mutate(ssy=((psi_5-value)/abs(psi_5))) |> 
  drop_na() |> 
  group_by(name) |> 
  summarise(t.test=t.test(value,psi_5)$p.value)
as.data.frame(psi,xy=TRUE)|>
  rename(real=psi_5,
         `LAI=2`=psi_2,
         `LAI=3`=psi_3,
         `LAI=4`=psi_4,
         `LAI=6`=psi_6,
         `LAI=7`=psi_7,
         `LAI=8`=psi_8
         ) |> 
  pivot_longer(cols=c("LAI=2","LAI=3","LAI=4","LAI=6","LAI=7","LAI=8")) |> 
  mutate(dif=cut((real-value)/1000,
                 breaks=c(-Inf, -2, -1, -0.500,-0.25, 0,0.25,0.500,1,2,Inf))) |> 
  ggplot()+
  geom_tile(aes(x=x,y=y,fill=dif))+
  geom_sf(data=europe, fill=NA)+
  coord_sf()+
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text = element_blank(),
        legend.key.size = unit(0.5,"cm"),
        legend.text = element_text(size=10),
        legend.title = element_text(size=11))+
  scale_fill_brewer(palette="RdYlBu")+
  facet_wrap(~name)+
  labs(fill=unname(TeX("$\\Psi_{min}-\\Psi_{new}(MPa)$")))->plot
ggsave("figures_rev/fig_si_lai.pdf",
       plot=plot,
       scale=1,
       dpi=600,
       width = 19,
       height = 12,
       units="cm")
  # facet_wrap(~name)
```


### toth curves

```{r}
theta=seq(0,1,by=0.00001)
hydrau_pars=data.frame(hor=as.numeric(),alpha=as.numeric(),m=as.numeric(),n=as.numeric(),thr=as.numeric(),ths=as.numeric())
for(i in 1:7){
  print(i)
  alpha=global(rast(paste0("data/EU_SoilHydroGrids_1km/MRC_alp_sl",i,".tif")),'mean',na.rm=TRUE)[[1]]
  m=global(rast(paste0("data/EU_SoilHydroGrids_1km/MRC_m_sl",i,".tif")),'mean',na.rm=TRUE)[[1]]
  n=global(rast(paste0("data/EU_SoilHydroGrids_1km/MRC_n_sl",i,".tif")),'mean',na.rm=TRUE)[[1]]
  thr=global(rast(paste0("data/EU_SoilHydroGrids_1km/MRC_thr_sl",i,".tif")),'mean',na.rm=TRUE)[[1]]
  ths=global(rast(paste0("data/EU_SoilHydroGrids_1km/MRC_ths_sl",i,".tif")),'mean',na.rm=TRUE)[[1]]
  hydrau_pars=rbind(hydrau_pars,list(hor=i,alpha=alpha,m=m,n=n,thr=thr,ths=ths))
}
merge(hydrau_pars,
      as.data.frame(theta)) |> 
  mutate(REW=(theta-thr*10^(-4))/((ths-thr)*10^(-4)),
         psi=case_when(theta<ths~(((1/REW)^(1/(m*10^(-4)))-1)^(1/(n*10^(-4)))*(1/(alpha*10^(-4)))*9.78*10^(-2))/1000,
                       theta>ths~ths*10^(-4)),
         Horizon=as.factor(hor)) |> 
  filter(psi>0.00002) |> 
  ggplot(aes(theta,psi,color=Horizon))+
  geom_line()+
  scale_y_log10()+
  scale_color_brewer(palette="Spectral",direction=-1)+
  labs(x=TeX("$\\theta$ (%)"),
       y=TeX("$\\Psi$ (MPa)"))+
  theme_minimal()->plot

# ggsave("figures_rev/fig_toth.png",
#        plot=plot,
#        scale=1,
#        dpi=600,
#        width = 8,
#        height = 9,
#        units="cm")
REW=(theta-thr*10^(-4))/((ths-thr)*10^(-4))
psi=-(((1/REW)^(1/(m*10^(-4)))-1)^(1/(n*10^(-4)))*(1/(alpha*10^(-4)))*9.78*10^(-2))
plot(theta,-psi)

```




### accounting for uncertainties
```{r eval=FALSE, include=FALSE}
hsm.95=quantile(db.clim$hsm,prob=0.95,na.rm=TRUE)[[1]]
hsm.05=quantile(db.clim$hsm,prob=0.05,na.rm=TRUE)[[1]]
fsm.95=quantile(db.clim$fsm,prob=0.95,na.rm=TRUE)[[1]]
fsm.05=quantile(db.clim$fsm,prob=0.05,na.rm=TRUE)[[1]]

df.range<-db.clim |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |> 
  group_by(species) |> 
  summarise(psi_range=max(psi_eraday_real)/1000-min(psi_eraday_real)/1000,
            t_range=max(tmin_era,na.rm=TRUE)-min(tmin_era,na.rm=TRUE))

c<-mod.select.safmarg %>%
  left_join(df.species) |>
  crossing(data.frame(xsm_val=c(seq(fsm.05,
                                    fsm.95,
                                    length.out=100),
                                seq(hsm.05,
                                    hsm.95,
                                    length.out=100)),
                      xsm_name=c(rep("Frost safety margins (°C)",100),
                                 rep("Hydraulic safety margins (MPa)",100)))) |> 
  filter((mod %in% c("2var","hsm") & xsm_name=="Hydraulic safety margins (MPa)")|
           mod %in% c("2var","fsm") & xsm_name=="Frost safety margins (°C)") |> 
  mutate(pred=case_when(mod=="2var"&xsm_name=="Hydraulic safety margins (MPa)"~k_int/((1+exp(-r_fsm*(fsm.95-t_fsm)))*
                                                            (1+exp(-r_hsm*(xsm_val-t_hsm)))),
                        mod=="2var"&xsm_name=="Frost safety margins (°C)"~k_int/((1+exp(-r_hsm*(hsm.95-t_hsm)))*
                                                            (1+exp(-r_fsm*(xsm_val-t_fsm)))),
                        mod=="hsm"~k_int/(1+exp(-r_hsm*(xsm_val-t_hsm))),
                        mod=="fsm"~k_int/(1+exp(-r_fsm*(xsm_val-t_fsm)))
                        )
         ) |>
  ggplot(aes(xsm_val,pred,color=taxa,linesize=species,linetype=mod))+ #color=prevalence,
  geom_vline(xintercept = 0,linetype="dashed")+
  geom_line(alpha=0.6,size=0.6)+
  scale_color_manual(values=c("chocolate2","forestgreen"))+
  # scale_color_gradientn(colours = viridis(15,direction=-1),
  #                       breaks=c(0,0.1,0.2,0.3,0.4,0.5,0.6))+
  guides(alpha="none")+
  labs(color="Species prevalence")+
  theme_minimal()+
  theme(axis.title= element_blank(),
        axis.ticks.x = element_line(linewidth = 0.6),
        axis.line = element_line(linewidth = 0.6),
        legend.position = "none",
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        strip.placement = "outside",
        strip.text = element_text(size=11,vjust=-1.1),
        text=element_text(size=12))+
    facet_wrap(~xsm_name,scales="free",
             strip.position = "bottom")+
  NULL


df.n<- mod.select.safmarg %>% 
  left_join(df.species) |> 
  rename(HSM=inflex_hsm,
         FSM=inflex_fsm) %>% 
  pivot_longer(col=c("HSM","FSM")) %>% 
  filter(mod!="none") %>% 
  filter(!(mod=="fsm"&name=="HSM")&
           !(mod=="hsm"&name=="FSM")) %>% 
  group_by(taxa,name) |> 
  summarise(n=n(),
            value=quantile(100-value,probs=0.5)[[1]]) |> 
  ungroup()
mod.select.safmarg %>%
  left_join(df.species) |> 
  mutate(HSM=100-inflex_hsm,
         FSM=100-inflex_fsm) %>% 
  pivot_longer(col=c("HSM","FSM")) %>% 
  filter(mod!="none") %>% 
  filter(!(mod=="fsm"&name=="HSM")&
           !(mod=="hsm"&name=="FSM")) %>% 
  ggplot(aes(name,value,fill=taxa))+
  geom_boxplot()+
  geom_text(data=df.n,
            mapping=aes(x=name,y=value,label=n),
            position = position_dodge(width=0.75),
            vjust=2)+
  geom_signif(comparisons = list(c("HSM","FSM")),
              map_signif_level = TRUE)+
  # geom_signif(comparisons = list(c("angiosperm","gymnosperm")),
  #             map_signif_level = TRUE)+
  # stat_compare_means(aes(label = ..p.signif..),
  #                    method = "t.test",
  #                    label.x = 1.5, label.y = 60)+
  scale_fill_manual(values=c("chocolate2","forestgreen"))+
  theme_minimal()+
  theme(axis.title.y = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_line(linewidth = 0.6),
        legend.title = element_blank(),
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        text=element_text(size=12))+
  labs(x="Inflexion index")-> b


#%%%%%%%%%%%%%%%%%%%
df.n<- mod.select.safmarg %>% 
  left_join(df.species) |>
    left_join(df.range) |> 
    dplyr::select(species,px,lt50,t_hsm,t_fsm,mod,psi_range,t_range,taxa) %>% 
    mutate(t_range=case_when(is.na(t_range)~mean(df.range$t_range,na.rm=TRUE),
                           TRUE~t_range),
         HSM=t_hsm/psi_range,
         FSM=t_fsm/t_range) |> 
  dplyr::select(taxa,species,mod,HSM,FSM) %>% 
  pivot_longer(cols=c("HSM","FSM"),names_to = "threshold",values_to = "traits_val") %>% 
  filter((mod%in%c("hsm","2sm")&threshold=="HSM")|
           (mod%in%c("fsm","2sm")&threshold=="FSM")) %>% 
  group_by(taxa,threshold) |> 
  summarise(n=n(),
            value=quantile(traits_val,probs=0.5)[[1]]) |> 
  ungroup()
mod.select.safmarg %>% 
  left_join(df.species) |>
  left_join(df.range) |> 
  dplyr::select(species,px,lt50,t_hsm,t_fsm,mod,psi_range,t_range,taxa) %>% 
  mutate(t_range=case_when(is.na(t_range)~mean(df.range$t_range,na.rm=TRUE),
                           TRUE~t_range),
         `HSM`=t_hsm/psi_range,
         FSM=t_fsm/t_range) |> 
  pivot_longer(cols=c("px","lt50"),names_to = "traits",values_to = "traits_val") %>% 
  pivot_longer(cols=c("HSM","FSM"),names_to="threshold",values_to="threshold_val") %>% 
  filter((mod%in%c("hsm","2sm")&traits=="px"&threshold=="HSM")|
           (mod%in%c("fsm","2sm")&traits=="lt50"&threshold=="FSM")) %>% 
  group_by(threshold) |> 
  mutate(n=n()) |> 
  ungroup() |> 
  ggplot(aes(threshold,threshold_val,fill=taxa))+
  geom_boxplot()+
  geom_text(data=df.n,
            mapping=aes(x=threshold,y=value,label=n),
            position = position_dodge(width=0.75),
            vjust=-0.5)+
  geom_signif(comparisons = list(c("HSM","FSM")),
              map_signif_level = TRUE)+
  # geom_text(data=df.n,mapping=aes(x=threshold,y=threshold_val,label=n))+
  # stat_compare_means(aes(label = ..p.signif..),
  #                    method = "t.test",
  #                    label.x = 1.5, label.y = 0.35)+
  scale_fill_manual(values=c("chocolate2","forestgreen"))+
  theme_minimal()+
  theme(axis.title.y= element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_line(linewidth = 0.6),
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        strip.placement = "outside",
        text=element_text(size=12))+
  labs(x="Rescaled thresholds")+
  NULL-> a

```


#### using posterior distribution
Threshold
```{r}
df.range<-db.clim |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |> 
  group_by(species) |> 
  summarise(psi_range=max(psi_eraday_real)/1000-min(psi_eraday_real)/1000,
            t_range=max(tmin_era,na.rm=TRUE)-min(tmin_era,na.rm=TRUE))
parameter=c("k_int","r_fsm","r_hsm","t_fsm","t_hsm")
threshold_prior=mod.select.safmarg  |> 
  pivot_longer(cols=parameter,
               names_to = "parameter",
               values_to = "par_val") |> 
  filter(par_val!=0) |> 
  select(species,mod,parameter,par_val) |> 
  filter(grepl("t_",parameter)) |> unique() |> 
  mutate(file=case_when(mod=="hsm"~paste0(species,"_hsm.RData"),
                        mod=="fsm"~paste0(species,"_fsm.RData"),
                        mod=="2var"~paste0(species,"_2sm.RData"),
                        mod=="none"~paste0(species,"_none.RData")))

threshold_post=threshold_prior |> 
  left_join(df.range,by=c("species"="species")) |> 
  pivot_longer(cols=c("psi_range","t_range")) |> 
  filter((parameter=="t_hsm"&name=="psi_range")|
           (parameter=="t_fsm"&name=="t_range")) |> 
  crossing(posterior=seq(888,889,length.out=1500)) 
  
# Loop over the files
  for (i in seq_along(threshold_prior$species)) {
    print(i)
    tryCatch({
      new_env <- new.env()
      load(file=paste0("fit_safmarg_era/", threshold_prior$file[i]),envir=new_env)
      obj_name <- ls(new_env)[1]
      model <- get(obj_name, envir = new_env)
      rm(new_env)
      posterior=as.data.frame(model)
      threshold_post[threshold_post$species==threshold_prior$species[i]&
                       threshold_post$parameter==threshold_prior$parameter[i],"posterior"]= 
        posterior[,threshold_prior$parameter[i]]
    },
    error=function(e){print(paste0("error for ",i))}
    )
    
  }

threshold_post |> 
  left_join(df.species[,c("taxa","species")],by=c("species"="species")) |> 
  mutate(rescale=posterior/value) |>
  ggplot(aes(parameter,rescale,fill=taxa))+
  geom_boxplot()+
  # geom_text(data=df.n,
  #           mapping=aes(x=threshold,y=value,label=n),
  #           position = position_dodge(width=0.75),
  #           vjust=-0.5)+
  # geom_signif(comparisons = list(c("HSM","FSM")),
  #             map_signif_level = TRUE)+
  # geom_text(data=df.n,mapping=aes(x=threshold,y=threshold_val,label=n))+
  # stat_compare_means(aes(label = ..p.signif..),
  #                    method = "t.test",
  #                    label.x = 1.5, label.y = 0.35)+
  scale_fill_manual(values=c("chocolate2","forestgreen"))+
  theme_minimal()+
  theme(axis.title.y= element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_line(linewidth = 0.6),
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        strip.placement = "outside",
        text=element_text(size=12))+
  labs(x="Rescaled thresholds")->ac
ac
a
```
Slope

```{r}
df.range<-db.clim |> 
  filter(presence==1) |> 
  filter(psi_eraday_real>(-10000)) |> 
  group_by(species) |> 
  summarise(psi_range=max(psi_eraday_real)/1000-min(psi_eraday_real)/1000,
            t_range=max(tmin_era,na.rm=TRUE)-min(tmin_era,na.rm=TRUE))

threshold_prior=mod.select.safmarg  |> 
  pivot_longer(cols=parameter,
               names_to = "parameter",
               values_to = "par_val") |> 
  filter(par_val!=0) |> 
  select(species,mod,parameter,par_val) |> 
  filter(grepl("r_",parameter)) |> unique() |> 
  mutate(file=case_when(mod=="hsm"~paste0(species,"_hsm.RData"),
                        mod=="fsm"~paste0(species,"_fsm.RData"),
                        mod=="2var"~paste0(species,"_2sm.RData"),
                        mod=="none"~paste0(species,"_none.RData")))

threshold_post=threshold_prior |> 
  left_join(df.range,by=c("species"="species")) |> 
  pivot_longer(cols=c("psi_range","t_range")) |> 
  filter((parameter=="r_hsm"&name=="psi_range")|
           (parameter=="r_fsm"&name=="t_range")) |> 
  crossing(posterior=seq(888,889,length.out=1500)) |> 
  mutate(posterior_t=posterior)
  
# Loop over the files
  for (i in seq_along(threshold_prior$species)) {
    print(i)
    tryCatch({
      new_env <- new.env()
      load(file=paste0("fit_safmarg_era/", threshold_prior$file[i]),envir=new_env)
      obj_name <- ls(new_env)[1]
      model <- get(obj_name, envir = new_env)
      rm(new_env)
      posterior=as.data.frame(model)
      threshold_post[threshold_post$species==threshold_prior$species[i]&
                       threshold_post$parameter==threshold_prior$parameter[i],c("posterior","posterior_t")]= 
        cbind(posterior[,threshold_prior$parameter[i]],
              posterior[,paste0("t_",str_sub(threshold_prior$parameter[i],-3,-1))])
              
    },
    error=function(e){print(paste0("error for ",i))}
    )
    
  }

threshold_post |> 
  left_join(df.species[,c("taxa","species")],by=c("species"="species")) |> 
  mutate(inflex=case_when(parameter=="r_hsm"~100-100*((16*exp(-posterior*(hsm.95-posterior_t)))/(2+2*exp(-posterior*(hsm.95-posterior_t)))^2),
                          parameter=="r_fsm"~100-100*((16*exp(-posterior*(fsm.95-posterior_t)))/(2+2*exp(-posterior*(fsm.95-posterior_t)))^2))) |> 
  ggplot(aes(parameter,inflex,fill=taxa))+
  geom_boxplot()+
  # geom_text(data=df.n,
  #           mapping=aes(x=threshold,y=value,label=n),
  #           position = position_dodge(width=0.75),
  #           vjust=-0.5)+
  # geom_signif(comparisons = list(c("HSM","FSM")),
  #             map_signif_level = TRUE)+
  # geom_text(data=df.n,mapping=aes(x=threshold,y=threshold_val,label=n))+
  # stat_compare_means(aes(label = ..p.signif..),
  #                    method = "t.test",
  #                    label.x = 1.5, label.y = 0.35)+
  scale_fill_manual(values=c("chocolate2","forestgreen"))+
  theme_minimal()+
  theme(axis.title.y= element_blank(),
        axis.ticks.x = element_blank(),
        axis.line.x = element_blank(),
        axis.line.y = element_line(linewidth = 0.6),
        # panel.grid = element_blank(),
        # panel.grid.major = element_line(color = "lightgrey",
        #                                   size =0.02),
        axis.text.y = element_text(hjust=0.5),
        strip.placement = "outside",
        text=element_text(size=12))+
  labs(x="Rescaled thresholds")->bc
bc
ac
b
```


### with mean niche 

```{r}
predictor=c("tmin_era","psi_eraday_real","wai","pet","map","mat","prpet","sgdd")

# get climatic data and traits by species 
db.clim.lm <- db.clim |>  
  filter(presence==1) |> 
  filter(psi_eraday_real>(-15000)) |>
  left_join(margin.limit) |> 
  mutate(prpet=map-pet) |> 
  pivot_longer(cols=all_of(predictor)) |> 
  group_by(name) |> 
  mutate(value=scale(value)) |> 
  ungroup() |> 
  group_by(species,hsm.valid.3,fsm.valid.2,name,lt50,px) |> 
  summarise(quant05=quantile(value,probs=0.05,na.rm=TRUE)[[1]],
            quant5=quantile(value,probs=0.5,na.rm=TRUE)[[1]],
            quant95=quantile(value,probs=0.95,na.rm=TRUE)[[1]]) |> 
  ungroup() |> 
  mutate(lt50=scale(lt50)[,1],
         px=scale(px)[,1]) |> 
  pivot_longer(cols=c("quant05","quant5","quant95"),
               names_to="quant_name",
               values_to = "quant_val") 
  # filter(!(hsm.valid.2==FALSE&name%in%c("wai","psi","prpet","pr","pet"))) |> 
  # filter(!(fsm.valid.2==FALSE&name%in%c("sgdd","frost.winter")))

# raw dataframe
df.lm.traits<-data.frame(pred=rep(predictor,2)) |> 
  crossing(trait=c("lt50","px"),
           quant=c("quant05","quant5","quant95"),
           mean=NA,
           sd=NA,
           pval=NA,
           r2=NA,
           conf.up=NA,
           conf.low=NA,
           n=NA)


for(pred in predictor){
  print(pred)
  for(quant in c("quant05","quant5","quant95")){
    print(quant)
    
    # test for p50
    db.clim.pred<-db.clim.lm |> 
      filter(name==pred) |> 
      filter(quant_name==quant)# |> 
      # filter(hsm.valid.3==TRUE) 
      # filter(mod%in%c("2sm","hsm"))
    summary=as.data.frame(summary(lm(quant_val~px,db.clim.pred))$coefficients)
    conf=confint(lm(formula = quant_val ~ px, data = db.clim.pred))
    print(summary(lm(quant_val~px,db.clim.pred)))
    df.lm.traits[df.lm.traits$pred==pred&
                   df.lm.traits$quant==quant&
                   df.lm.traits$trait=="px",
                 c("mean","sd","pval","r2","conf.up","conf.low","n")]=
      c(summary["px",c("Estimate","Std. Error","Pr(>|t|)")],
        summary(lm(quant_val~px,db.clim.pred))$r.squared,
        conf["px",1],
        conf["px",2],
        dim(db.clim.pred)[1])
    
    
    #test for lt50
    db.clim.pred<-db.clim.lm |> 
      filter(name==pred) |> 
      filter(quant_name==quant)# |> 
      # filter(fsm.valid.2==TRUE)
      # filter(mod%in%c("2sm","fsm"))
    summary=as.data.frame(summary(lm(quant_val~lt50,db.clim.pred))$coefficients)
    conf=confint(lm(formula = quant_val ~ lt50, data = db.clim.pred))
    print(summary(lm(quant_val~lt50,db.clim.pred)))
    df.lm.traits[df.lm.traits$pred==pred&
                   df.lm.traits$quant==quant&
                   df.lm.traits$trait=="lt50",
                 c("mean","sd","pval","r2","conf.up","conf.low","n")]=
      c(summary["lt50",c("Estimate","Std. Error","Pr(>|t|)")],
        summary(lm(quant_val~lt50,db.clim.pred))$r.squared,
        conf["lt50",1],
        conf["lt50",2],
        dim(db.clim.pred)[1])
    rm(db.clim.pred)
  }
}


df.lm.traits<-df.lm.traits |> 
  mutate(signif1=pval<0.001,
         signif2=pval>0.001&pval<0.01,
         signif3=pval>0.01&pval<0.05,
         text1=ifelse(signif3,"*",
                      ifelse(signif2,"**",
                             ifelse(signif1,"***",""))),
         text2=ifelse(signif3, paste0("R2=",round(r2, digits = 2)),
                               ifelse(signif2,paste0("R2=",round(r2,digits=2)),
                                      ifelse(signif1,paste0("R2=",round(r2,digits=2)),""))))

df.lm.traits |> 
  # filter the relevant quantile for each variable (ie stressful edge)
  # filter((pred%in% c("sgdd","tmin_era","psi_eraday_real","wai","prpet","map","mat") & quant=="quant05")|
  #          (pred=="pet"& quant=="quant95")) |>
  # filter the relevant trait for each variable
  filter((trait=="lt50"&(pred %in% c("sgdd","tmin_era","mat")))|
           (trait=="px"&(pred %in% c("wai","psi_eraday_real","prpet","map","pet")))) |> 
  # rename traits
  mutate(trait=case_when(trait=="px"~"$\\Psi_{crit}$",
                         trait=="lt50"~"$LT_{50}$")) |> 
  # filter variables
  filter(pred %in% c("mat","tmin_era","psi_eraday_real","pet","map")) |> 
  # rename
  mutate(pred=case_when(pred=="tmin_era"~"$T_{min}$",
                        pred=="psi_eraday_real"~"$\\Psi_{min}$",
                        # pred=="temp.mean"~"mat",
                        # pred=="pr"~"map",
                        TRUE~pred)) |> 
  mutate(quant=forcats::fct_recode(quant, "5%"="quant05","50%"="quant5", "95%"="quant95")) |> 
  ggplot(aes(x=mean,y=pred,color=quant))+
  geom_point(size=2.5,alpha=0.6,position=position_dodge(width=0.5))+ #,position=position_dodge(width=0.5)
  geom_pointrange(aes(xmin=conf.low,xmax=conf.up),position=position_dodge(width=0.5))+ #,position=position_dodge(width=0.5)
  geom_text(aes(label = text1,
                x=mean,
                y=pred
                ),
            # position = position_dodge(9),
            size=15/.pt,
            show.legend = FALSE,
            vjust=-0.25)+
  geom_text(aes(label = text2,
              x=mean,
              y=pred
              ),
          # position = position_dodge(9),
          size=8/.pt,
          show.legend = FALSE,
          vjust=2)+
  geom_vline(xintercept = 0,linetype="dotted")+
  scale_color_manual(values=c("darkred","grey","lightblue"))+
  scale_y_discrete(label=TeX)+
  facet_wrap(~trait,
             labeller=as_labeller(TeX,
                                  default = label_parsed),
             scales = "free_y")+
  theme_minimal()+
  theme(axis.title= element_blank(),
        axis.ticks.x = element_line(linewidth = 0.6),
        axis.line.x = element_line(linewidth = 0.6),
        panel.grid = element_blank(),
        legend.position = "top",
        axis.text.y = element_text(hjust=0.5),
        text=element_text(size=11))+
  xlim(-1,1.1)+
  labs(color="Quantiles")->a

# ggsave("figures_rev/fig1_gg.pdf",
#        plot=a,
#        # scale=1,
#        dpi=600,
#        width = 9,
#        height = 8,
#        units="cm")
rm(a,df.lm.traits,summary,conf,db.clim.lm,pred,predictor,quant)
```


### Comparison quantiles and gev


```{r}
library(extRemes)
# tmin=crop(project(rast("data/ERA5-land/t2m/tasmin_all.grib"),
#                   "EPSG:4326"),
#                   vect(europe))
tmin<-rast("data/ERA5-land/t2m/tasmin_all.grib")

point.samp <- db.clim |> 
  select(node,x,y) |> unique() |> 
  sample_n(1000)

# Extract raster values at points
tmin_series <-cbind(point.samp[,c("x","y")],
                    extract(tmin, point.samp[,c("x","y")])[-1]) 
colnames(tmin_series)=c("x","y",paste0("year_",1984:2021))
tmin_series<-tmin_series |>   filter(!is.na(year_1986)) |> 
  filter(across(.cols=matches("year"),
                ~.x<273.15))
  select(x,y)

tasmin_points <- t(extract(tasmin, tmin_series[,c("x","y")])[-1]) -273.15
matplot(tasmin_points, type = "l")

q_05_vec <- rp_vec <- rep(NA, ncol(tasmin_points))
for (i in 1:ncol(tasmin_points)){
  print(i)
 fit <- fevd(-tasmin_points[, i])
 rp_vec[i] <- -return.level(fit, return.period = 20)
 q_05_vec[i] <- quantile(tasmin_points[, i], probs = 0.05)
}

i=904
as.data.frame(cbind(rp_vec,
      q_05_vec)) |> 
  filter(rp_vec>(-100)) |> 
  ggplot(aes(rp_vec,q_05_vec))+
  geom_point(alpha=0.6,color="darkgrey",fill="darkgrey")+
  geom_abline(slope=1,color="darkred")+
  theme_minimal()+
  labs(x="Minimum temperature with return rate of 20 years",
       y="5th percentile of temperature time series")->a
# 
# ggsave("figures_rev/fig_rev_1.pdf",
#        plot=a,
#        dpi=600,
#        width=10,
#        height = 9,
#        unit="cm")
# 
```


### Sources of species 

```{r}
colddb=read.csv2("data/Species traits/ColdDB.csv") |> 
  filter(Species %in% mod.select.safmarg$species) |> 
  select(Species,Provenance,Temperature_of_resistance,Type,Fit,Method,Reference) |> 
  mutate(Reference=case_when(Reference=="Larter et al. unpub"~"Measured",
                             Reference=="Charrier Unpub"~"Measured",
                             TRUE~Reference)) |> 
  select(Species,Reference) |> unique()
colddb |> 
  left_join(traits,by=c("Species"="species")) |> 
  select(Species,lt50,Reference) |>
  mutate(p50=NA,
         ref=NA) -> t
t<-t |> 
  filter(!grepl("Fiorino",Reference)) |> 
  filter(!grepl("Sanatrius",Reference)) |> 
  arrange(Species,Reference)
print(xtable(t),include.rownames=FALSE)

t |> select(Reference) |> unique() |> arrange(Reference) ->ref
print(xtable(ref),include.rownames=FALSE)

p50db=read.csv2("data/Species traits/P50DB_source.csv") |> 
  filter(Species %in% mod.select.safmarg$species) |> 
  select(Species,Source) |> unique()
p50xft=read.csv2("data/Species traits/xft_filtered.csv") |> 
  mutate(Species=paste0(Genus," ",Species)) |> 
  filter(Species %in% mod.select.safmarg$species) |> 
  select(Species,Short_reference_.authors_year.,Ref_DOI) |> unique() |> 
  left_join(p50db) |> 
  mutate(reference=case_when(Source=="NicoMSP"~"Martin St-Paul et al. 2017",
                             TRUE~Short_reference_.authors_year.)) 
t<-p50xft |> 
  left_join(traits,by=c("Species"="species")) |> 
  select(Species,p50,p88,reference) |> 
  arrange(Species,reference)

print(xtable(t),include.rownames=FALSE)

ref <- p50xft |> 
  left_join(traits,by=c("Species"="species")) |> 
  select(reference) |> unique() |> 
  arrange(reference) 


print(xtable(ref),include.rownames=FALSE)
```

